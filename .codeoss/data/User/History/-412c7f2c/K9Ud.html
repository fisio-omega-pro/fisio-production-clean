<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura tu Cl√≠nica</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f4f7f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 100%; max-width: 600px; }
        
        /* Barra de Progreso */
        .progress-container { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        .progress-bg { position: absolute; top: 50%; left: 0; width: 100%; height: 4px; background: #eee; z-index: 0; transform: translateY(-50%); }
        .progress-bar { position: absolute; top: 50%; left: 0; height: 4px; background: #007bff; z-index: 1; transform: translateY(-50%); transition: 0.3s; width: 33%; }
        .step-indicator { width: 30px; height: 30px; background: #fff; border: 2px solid #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2; font-weight: 600; font-size: 14px; color: #999; transition: 0.3s; }
        .step-indicator.active { border-color: #007bff; color: #007bff; }
        .step-indicator.completed { background: #007bff; border-color: #007bff; color: #fff; }

        h2 { text-align: center; color: #1a1a1a; margin-bottom: 10px; }
        p.subtitle { text-align: center; color: #666; font-size: 0.9em; margin-bottom: 30px; }
        
        .step { display: none; animation: fadeIn 0.4s; }
        .step.active { display: block; }
        
        label { display: block; margin-top: 15px; font-weight: 600; font-size: 0.9em; color: #444; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; transition: 0.2s; }
        input:focus { border-color: #007bff; outline: none; }
        
        /* Checkboxes Estilizados */
        .checkbox-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 5px; }
        .checkbox-card { border: 1px solid #ddd; padding: 12px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; background: #fff; font-weight: 500; flex: 1; min-width: 120px; justify-content: center; }
        .checkbox-card:hover { border-color: #007bff; background: #f0f7ff; }
        .checkbox-card.selected { background: #e3f2fd; border-color: #007bff; color: #0056b3; }
        .checkbox-card input { display: none; } /* Ocultar checkbox real */

        /* Caja Legal */
        .legal-box { background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-top: 25px; display: flex; gap: 10px; align-items: flex-start; }
        .legal-box input { width: 20px; height: 20px; margin-top: 2px; cursor: pointer; }
        .legal-text { font-size: 0.85em; color: #555; line-height: 1.4; }
        .legal-text a { color: #007bff; text-decoration: none; }

        .btn-box { margin-top: 30px; display: flex; justify-content: space-between; }
        button { padding: 14px 28px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: 0.2s; }
        .btn-next { background: #007bff; color: white; width: 100%; }
        .btn-next:hover { background: #0056b3; box-shadow: 0 4px 12px rgba(0,123,255,0.2); }
        .btn-prev { background: transparent; color: #666; border: 1px solid #ddd; width: auto; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="card">
    <!-- Barra de Pasos -->
    <div class="progress-container">
        <div class="progress-bg"></div>
        <div class="progress-bar" id="progressBar"></div>
        <div class="step-indicator active" id="ind1">1</div>
        <div class="step-indicator" id="ind2">2</div>
        <div class="step-indicator" id="ind3">3</div>
    </div>

    <form id="regForm">
        <!-- PASO 1: IDENTIDAD -->
        <div class="step active" id="step1">
            <h2>Identidad de la Cl√≠nica</h2>
            <p class="subtitle">Empecemos por lo b√°sico.</p>
            
            <label>Nombre Comercial</label>
            <input type="text" name="nombre_clinica" required placeholder="Ej: Fisioterapia Bienestar">
            
            <label>Email de Usuario</label>
            <input type="email" name="email" required placeholder="admin@tucorreo.com">
            
            <label>Contrase√±a</label>
            <input type="password" name="password" required minlength="6">

            <div class="btn-box">
                <button type="button" class="btn-next" onclick="validateAndNext(1)">Siguiente Paso</button>
            </div>
        </div>

        <!-- PASO 2: UBICACI√ìN -->
        <div class="step" id="step2">
            <h2>¬øD√≥nde est√°is?</h2>
            <p class="subtitle">Para que Ana gu√≠e a los pacientes.</p>
            
            <div style="display: flex; gap: 10px;">
                <div style="flex:3"><label>Calle</label><input type="text" name="calle" required></div>
                <div style="flex:1"><label>N¬∫</label><input type="text" name="numero" required></div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <div style="flex:1"><label>Ciudad</label><input type="text" name="ciudad" required></div>
                <div style="flex:1"><label>Provincia</label><input type="text" name="provincia" required></div>
            </div>
            
            <div class="btn-box">
                <button type="button" class="btn-prev" onclick="prevStep(1)">Atr√°s</button>
                <div style="width: 20px;"></div>
                <button type="button" class="btn-next" onclick="validateAndNext(2)">Siguiente</button>
            </div>
        </div>

        <!-- PASO 3: REGLAS Y LEGAL -->
        <div class="step" id="step3">
            <h2>Reglas de Negocio</h2>
            <p class="subtitle">Configura precios y condiciones.</p>
            
            <div style="display: flex; gap: 10px;">
                <div style="flex:1"><label>Precio (‚Ç¨)</label><input type="number" name="precio" value="50" required></div>
                <div style="flex:1"><label>Duraci√≥n (min)</label><input type="number" name="duracion" value="45" required></div>
            </div>

            <label>M√©todos de Cobro Aceptados</label>
            <div class="checkbox-group">
                <div class="checkbox-card" onclick="toggleCheck(this)">
                    Efectivo <input type="checkbox" name="pago_efectivo" value="Efectivo" checked>
                </div>
                <div class="checkbox-card" onclick="toggleCheck(this)">
                    Tarjeta <input type="checkbox" name="pago_tarjeta" value="Tarjeta">
                </div>
                <div class="checkbox-card" onclick="toggleCheck(this)">
                    Bizum <input type="checkbox" name="pago_bizum" value="Bizum">
                </div>
            </div>

            <label>Fianza Anti No-Show (‚Ç¨)</label>
            <input type="number" name="fianza" placeholder="0 para desactivar">

            <!-- CHECKBOX LEGAL (LO NUEVO) -->
            <div class="legal-box">
                <input type="checkbox" id="checkLegal" required>
                <div class="legal-text">
                    He le√≠do y acepto la <a href="#">Pol√≠tica de Privacidad</a> y los <a href="#">T√©rminos del Servicio</a>. Consiento el tratamiento de mis datos y autorizo el uso del Asistente IA.
                </div>
            </div>

            <div class="btn-box">
                <button type="button" class="btn-prev" onclick="prevStep(2)">Atr√°s</button>
                <div style="width: 20px;"></div>
                <button type="submit" class="btn-next" style="background:#28a745;">FINALIZAR Y ENTRAR</button>
            </div>
        </div>
    </form>
</div>

<script>
    function toggleCheck(card) {
        const checkbox = card.querySelector('input');
        checkbox.checked = !checkbox.checked;
        if(checkbox.checked) card.classList.add('selected');
        else card.classList.remove('selected');
    }
    // Inicializar visualmente los checked
    document.querySelectorAll('.checkbox-card input:checked').forEach(c => c.parentElement.classList.add('selected'));

    function validateAndNext(step) {
        const div = document.getElementById('step'+step);
        const inputs = div.querySelectorAll('input[required]');
        let valid = true;
        inputs.forEach(i => {
            if(!i.value) { i.style.borderColor = 'red'; valid = false; }
            else { i.style.borderColor = '#ddd'; }
        });

        if(valid) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step'+(step+1)).classList.add('active');
            
            // Actualizar barra
            document.querySelectorAll('.step-indicator').forEach((ind, idx) => {
                if(idx < step) ind.classList.add('completed');
                if(idx === step) ind.classList.add('active');
            });
            document.getElementById('progressBar').style.width = ((step)*50) + "%";
        }
    }

    function prevStep(step) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step'+step).classList.add('active');
    }

    document.getElementById('regForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // VALIDACI√ìN LEGAL CR√çTICA
        if(!document.getElementById('checkLegal').checked) {
            alert("üõë Debes aceptar la Pol√≠tica de Privacidad para continuar.");
            return;
        }

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // Arrays
        data.metodos_pago = [];
        if(document.querySelector('input[name="pago_efectivo"]').checked) data.metodos_pago.push('Efectivo');
        if(document.querySelector('input[name="pago_tarjeta"]').checked) data.metodos_pago.push('Tarjeta');
        if(document.querySelector('input[name="pago_bizum"]').checked) data.metodos_pago.push('Bizum');

        const btn = document.querySelector('button[type="submit"]');
        btn.innerHTML = "Creando Cl√≠nica...";
        btn.disabled = true;

        try {
            const res = await fetch('/api/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            
            if(result.success) {
                window.location.href = result.dashboard_url;
            } else {
                alert("Error: " + result.error);
                btn.disabled = false;
            }
        } catch(err) { alert("Error conexi√≥n"); btn.disabled = false; }
    });
</script>

</body>
</html>