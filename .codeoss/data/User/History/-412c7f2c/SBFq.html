<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Configuraci√≥n Avanzada | FisioTool</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Manrope:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0F172A; --gold: #C5A059; --bg: #F8FAFC; --card: #FFFFFF; }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 700px; margin: 0 auto; background: var(--card); padding: 40px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        h1 { font-family: 'Playfair Display', serif; color: var(--primary); text-align: center; }
        h3 { border-bottom: 2px solid #E2E8F0; padding-bottom: 10px; margin-top: 30px; color: var(--gold); }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 15px; border: 1px solid #E2E8F0; border-radius: 8px; outline: none; transition:0.3s; font-family:'Manrope'; }
        input:focus { border-color: var(--gold); }
        
        /* Checks personalizados */
        .checkbox-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .check-item { background: #F1F5F9; padding: 10px; border-radius: 6px; font-size: 13px; display:flex; align-items:center; }
        .check-item input { width: auto; margin-right: 10px; }

        .btn-save { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 30px; font-size: 16px;}
    </style>
</head>
<body>
    <div class="container">
        <h1>Cerebro Cl√≠nico FisioTool üß†</h1>
        <p style="text-align:center; color:#64748B;">Configura las reglas de seguros y banderas rojas.</p>
        
        <form id="full-form">
            <!-- BLOQUE 1: B√ÅSICOS -->
            <h3>1. Identidad de la Cl√≠nica</h3>
            <div class="form-group"><label>Nombre Comercial</label><input type="text" id="clinic_name" placeholder="Ej: Cl√≠nica FisioSalud" required></div>
            <div class="form-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div><label>Precio Sesi√≥n (‚Ç¨)</label><input type="number" id="price" value="50"></div>
                <div><label>Duraci√≥n (min)</label><select id="duration"><option value="30">30 min</option><option value="45" selected>45 min</option><option value="60">60 min</option></select></div>
            </div>

            <!-- BLOQUE 2: SEGUROS (DOLOR CLAVE) -->
            <h3>2. Seguros y Mutuas</h3>
            <div class="form-group">
                <label>Pol√≠tica de Seguros</label>
                <select id="insurance_type" onchange="toggleMutuas()">
                    <option value="privado">100% Privado (No aceptamos seguros)</option>
                    <option value="mixto">H√≠brido (Privado + Seguros)</option>
                </select>
            </div>
            <div class="form-group" id="mutuas-box" style="display:none;">
                <label>Lista las Mutuas aceptadas (Separadas por comas)</label>
                <textarea id="insurance_list" placeholder="Ej: Sanitas, Asisa, Mapfre... (El resto ser√°n rechazadas)"></textarea>
            </div>

            <!-- BLOQUE 3: BANDERAS ROJAS -->
            <h3>3. Cribado (Red Flags) üö©</h3>
            <p style="font-size:12px; color:#64748B; margin-bottom:15px;">Marca qu√© pacientes NO deben ser agendados por la IA (se derivar√°n a llamada).</p>
            <div class="checkbox-group">
                <label class="check-item"><input type="checkbox" class="redflag" value="accidentes de tr√°fico"> Accidentes Tr√°fico</label>
                <label class="check-item"><input type="checkbox" class="redflag" value="beb√©s o pedi√°trico"> Beb√©s / Pediatr√≠a</label>
                <label class="check-item"><input type="checkbox" class="redflag" value="suelo p√©lvico"> Suelo P√©lvico</label>
                <label class="check-item"><input type="checkbox" class="redflag" value="drenaje linf√°tico"> Drenaje Linf√°tico</label>
                <label class="check-item"><input type="checkbox" class="redflag" value="neurolog√≠a"> Neurol√≥gico</label>
                <label class="check-item"><input type="checkbox" class="redflag" value="ATM/Mand√≠bula"> ATM (Mand√≠bula)</label>
            </div>

            <!-- BLOQUE 4: LOG√çSTICA -->
            <h3>4. Log√≠stica</h3>
            <div class="form-group">
                <label>Informaci√≥n de Parking (Bot la usar√° si preguntan)</label>
                <input type="text" id="parking_info" placeholder="Ej: Parking p√∫blico Plaza Mayor a 50m. Zona azul en la puerta.">
            </div>

            <button type="submit" class="btn-save">ACTIVAR INTELIGENCIA CL√çNICA üöÄ</button>
            <p id="msg" style="text-align: center; margin-top: 15px; font-weight: bold;"></p>
        </form>
    </div>

    <script>
        function toggleMutuas() {
            const val = document.getElementById('insurance_type').value;
            document.getElementById('mutuas-box').style.display = (val === 'mixto') ? 'block' : 'none';
        }

        document.getElementById('full-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.querySelector('.btn-save'); btn.disabled=true; btn.innerText="Guardando...";
            
            // Recoger RedFlags marcadas
            let flags = [];
            document.querySelectorAll('.redflag:checked').forEach((cb) => flags.push(cb.value));

            const data = {
                nombre_comercial: document.getElementById('clinic_name').value,
                precio_sesion: document.getElementById('price').value,
                duracion: document.getElementById('duration').value,
                politica_seguros: document.getElementById('insurance_type').value, // 'privado' o 'mixto'
                lista_seguros: document.getElementById('insurance_list').value || "Ninguno",
                banderas_rojas: flags,
                parking: document.getElementById('parking_info').value
            };

            try {
                const res = await fetch('/onboarding/save', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if(res.ok) window.location.href = '/panel';
            } catch(err) {
                document.getElementById('msg').innerText = "Error conexi√≥n.";
            }
        });
    </script>
</body>
</html>