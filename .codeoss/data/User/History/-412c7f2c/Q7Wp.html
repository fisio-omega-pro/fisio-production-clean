<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Fisiotool</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 550px; }
        h2 { text-align: center; color: #1a1a1a; margin-bottom: 30px; font-weight: 600; }
        .step { display: none; animation: fadeIn 0.4s; }
        .step.active { display: block; }
        
        label { display: block; margin-top: 20px; font-weight: 600; font-size: 0.9em; color: #4a4a4a; margin-bottom: 8px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; transition: 0.3s; }
        input:focus { border-color: #007bff; outline: none; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        
        /* Checkboxes bonitos (Tarjetas) */
        .checkbox-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .checkbox-card { border: 1px solid #ddd; padding: 10px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; background: #fff; font-size: 0.9em; }
        .checkbox-card:hover { background: #f9f9f9; border-color: #bbb; }
        .checkbox-card input { width: auto; margin: 0; }
        .checkbox-card.selected { background: #e3f2fd; border-color: #007bff; color: #007bff; font-weight: 600; }

        /* Banderas Rojas (Tags) */
        .red-flag-label { color: #d32f2f; }
        .flag-card { border: 1px solid #ffcdd2; color: #c62828; }
        .flag-card:hover { background: #ffebee; }
        .flag-card.selected { background: #ffebee; border-color: #c62828; font-weight: 600; }

        .btn-box { margin-top: 30px; display: flex; justify-content: space-between; }
        button { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; transition: 0.2s; }
        .btn-next { background: #007bff; color: white; }
        .btn-prev { background: #e4e6eb; color: #333; }
        .referral-banner { background: #e8f0fe; color: #1967d2; padding: 15px; border-radius: 8px; margin-bottom: 25px; text-align: center; font-weight: 500; display: none; }
        .hint { font-size: 0.8em; color: #888; margin-top: 5px; }
        
        /* Error visual */
        input.invalid { border-color: #dc3545; background-color: #fff8f8; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="card">
    <div id="referralMsg" class="referral-banner">üéÅ ¬°Genial! Tienes un 50% de descuento por venir invitado.</div>
    
    <form id="regForm">
        <!-- PASO 1: DATOS CUENTA -->
        <div class="step active" id="step1">
            <h2>1. Crea tu Cuenta</h2>
            <label>Nombre de tu Cl√≠nica *</label>
            <input type="text" name="nombre_clinica" required placeholder="Ej: Fisioterapia Avanzada">
            
            <label>Email de Acceso *</label>
            <input type="email" name="email" required placeholder="tu@email.com">
            
            <label>Contrase√±a *</label>
            <input type="password" name="password" required minlength="6" placeholder="M√≠nimo 6 caracteres">

            <label>C√≥digo de Invitaci√≥n (Opcional)</label>
            <input type="text" id="codInvitacion" name="codigo_invitacion" placeholder="P√©galo aqu√≠ si lo tienes">
            
            <div class="btn-box" style="justify-content: flex-end;">
                <button type="button" class="btn-next" onclick="validateAndNext(1)">Siguiente ‚û°</button>
            </div>
        </div>

        <!-- PASO 2: UBICACI√ìN -->
        <div class="step" id="step2">
            <h2>2. Ubicaci√≥n Principal</h2>
            
            <div style="display: flex; gap: 15px;">
                <div style="flex: 3;">
                    <label>Calle *</label>
                    <input type="text" name="calle" required placeholder="Av. de la Libertad">
                </div>
                <div style="flex: 1;">
                    <label>N√∫mero *</label>
                    <input type="text" name="numero" required placeholder="123">
                </div>
            </div>
            
            <div style="display: flex; gap: 15px;">
                <div style="flex:1">
                    <label>C√≥digo Postal *</label>
                    <input type="text" name="cp" required>
                </div>
                <div style="flex:1">
                    <label>Ciudad *</label>
                    <input type="text" name="ciudad" required>
                </div>
            </div>
            
            <label>Provincia *</label>
            <input type="text" name="provincia" required>
            
            <div class="btn-box">
                <button type="button" class="btn-prev" onclick="prevStep(1)">‚¨Ö Atr√°s</button>
                <button type="button" class="btn-next" onclick="validateAndNext(2)">Siguiente ‚û°</button>
            </div>
        </div>

        <!-- PASO 3: CEREBRO IA -->
        <div class="step" id="step3">
            <h2>3. Configuraci√≥n Inteligente</h2>
            
            <div style="display: flex; gap: 15px;">
                <div style="flex:1">
                    <label>Precio Sesi√≥n (‚Ç¨) *</label>
                    <input type="number" name="precio" value="50" required>
                </div>
                <div style="flex:1">
                    <label>Duraci√≥n (min) *</label>
                    <input type="number" name="duracion" value="45" required>
                </div>
            </div>

            <label>¬øC√≥mo cobras en la consulta?</label>
            <div class="checkbox-group">
                <label class="checkbox-card selected"><input type="checkbox" name="pago_efectivo" value="Efectivo" checked onchange="toggleCard(this)"> Efectivo</label>
                <label class="checkbox-card"><input type="checkbox" name="pago_tarjeta" value="Tarjeta" onchange="toggleCard(this)"> Tarjeta</label>
                <label class="checkbox-card"><input type="checkbox" name="pago_bizum" value="Bizum" onchange="toggleCard(this)"> Bizum</label>
            </div>

            <label class="red-flag-label">üö© Banderas Rojas (Filtros de Seguridad)</label>
            <p class="hint">Selecciona qu√© casos prefieres NO atender autom√°ticamente:</p>
            <div class="checkbox-group">
                <label class="checkbox-card flag-card"><input type="checkbox" name="flag_accidente" value="accidente tr√°fico" onchange="toggleCard(this)"> Accidente Tr√°fico</label>
                <label class="checkbox-card flag-card"><input type="checkbox" name="flag_seguro" value="seguro m√©dico" onchange="toggleCard(this)"> Seguros M√©dicos</label>
                <label class="checkbox-card flag-card"><input type="checkbox" name="flag_embarazo" value="embarazo" onchange="toggleCard(this)"> Embarazo</label>
                <label class="checkbox-card flag-card"><input type="checkbox" name="flag_menor" value="menor de edad" onchange="toggleCard(this)"> Menores</label>
            </div>
            <input type="text" name="flag_otros" placeholder="Otro... (Escribe y separa por comas)" style="margin-top:10px;">

            <label>Pol√≠tica Anti No-Show</label>
            <input type="number" name="fianza" placeholder="Ej: 15‚Ç¨ (Deja vac√≠o para desactivar)">

            <div style="margin-top:20px; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                <label style="margin-top:0"><input type="checkbox" name="acepta_bonos"> Activar Sistema de Bonos</label>
            </div>

            <div class="btn-box">
                <button type="button" class="btn-prev" onclick="prevStep(2)">‚¨Ö Atr√°s</button>
                <button type="submit" class="btn-next" style="background: #28a745;">CONTINUAR AL PAGO üí≥</button>
            </div>
        </div>
    </form>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    if(params.get('ref')) {
        document.getElementById('codInvitacion').value = params.get('ref');
        document.getElementById('referralMsg').style.display = 'block';
    }

    function toggleCard(checkbox) {
        if(checkbox.checked) checkbox.parentElement.classList.add('selected');
        else checkbox.parentElement.classList.remove('selected');
    }

    function validateAndNext(currentStepId) {
        const currentStepDiv = document.getElementById('step' + currentStepId);
        const inputs = currentStepDiv.querySelectorAll('input[required], select[required]');
        let isValid = true;

        inputs.forEach(input => {
            if (!input.value.trim()) {
                isValid = false;
                input.classList.add('invalid');
                // Quitar rojo cuando escriba
                input.addEventListener('input', () => input.classList.remove('invalid'), {once:true});
            }
        });

        if (isValid) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + (currentStepId + 1)).classList.add('active');
        } else {
            alert("‚ö†Ô∏è Por favor, rellena los campos obligatorios marcados en rojo.");
        }
    }

    function prevStep(step) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + step).classList.add('active');
    }

    document.getElementById('regForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // Recopilar Arrays Manualmente
        data.metodos_pago = [];
        if(document.querySelector('input[name="pago_efectivo"]').checked) data.metodos_pago.push('Efectivo');
        if(document.querySelector('input[name="pago_tarjeta"]').checked) data.metodos_pago.push('Tarjeta');
        if(document.querySelector('input[name="pago_bizum"]').checked) data.metodos_pago.push('Bizum');

        // Recopilar Banderas Rojas
        let flags = [];
        if(document.querySelector('input[name="flag_accidente"]').checked) flags.push('accidente tr√°fico');
        if(document.querySelector('input[name="flag_seguro"]').checked) flags.push('seguro m√©dico');
        if(document.querySelector('input[name="flag_embarazo"]').checked) flags.push('embarazo');
        if(document.querySelector('input[name="flag_menor"]').checked) flags.push('menor de edad');
        if(data.flag_otros) flags = flags.concat(data.flag_otros.split(','));
        
        data.banderas_rojas = flags.join(','); // Lo enviamos como string separado por comas
        data.acepta_bonos = document.querySelector('input[name="acepta_bonos"]').checked;

        const btn = document.querySelector('button[type="submit"]');
        btn.innerHTML = "Procesando...";
        btn.disabled = true;

        try {
            const res = await fetch('/api/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            
            if(result.success) {
                // AQU√ç ES DONDE METER√çAMOS LA REDIRECCI√ìN A STRIPE EN EL FUTURO
                // window.location.href = "/api/stripe/checkout?clinic_id=" + result.clinic_id;
                
                alert("‚úÖ Cuenta Creada. (Simulando Pago Correcto...)");
                window.location.href = result.dashboard_url;
            } else {
                alert("Error: " + result.error);
                btn.innerHTML = "Reintentar";
                btn.disabled = false;
            }
        } catch(err) {
            alert("Error de conexi√≥n");
            btn.disabled = false;
        }
    });
</script>

</body>
</html>