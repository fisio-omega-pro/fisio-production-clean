<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FisioTool Pro - Gesti√≥n de √âlite</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/es.global.min.js'></script>

<style>
:root {
--primary: #0066ff;
--primary-dark: #0052cc;
--primary-light: #eef5ff;
--success: #10b981;
--danger: #ef4444;
--warning: #f59e0b;
--bg-body: #f8fafc;
--white: #ffffff;
--text-main: #0f172a;
--text-muted: #64748b;
--border: #e2e8f0;
--radius-xl: 32px;
--radius-lg: 24px;
--shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
--shadow-md: 0 10px 15px -3px rgba(0,0,0,0.05);
--shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1);
}

body { 
  font-family: 'Inter', sans-serif; 
  background: var(--bg-body); 
  margin: 0; 
  display: flex; 
  height: 100vh; 
  color: var(--text-main); 
  overflow: hidden; 
}

.sidebar {
  width: 300px; 
  background: var(--white); 
  border-right: 1px solid var(--border);
  display: flex; 
  flex-direction: column; 
  padding: 40px 30px; 
  box-sizing: border-box;
  box-shadow: 10px 0 30px rgba(0,0,0,0.02);
}

.logo-box { 
  font-size: 26px; 
  font-weight: 800; 
  color: var(--primary); 
  margin-bottom: 50px; 
  display: flex; 
  align-items: center; 
  gap: 15px; 
  letter-spacing: -1px; 
}

.logo-icon { 
  width: 16px; 
  height: 16px; 
  background: var(--primary); 
  border-radius: 5px; 
  box-shadow: 0 0 15px var(--primary); 
}

.nav-group { margin-bottom: 35px; }

.nav-label { 
  font-size: 11px; 
  font-weight: 800; 
  color: #94a3b8; 
  text-transform: uppercase; 
  letter-spacing: 1.5px; 
  margin-bottom: 15px; 
  padding-left: 10px; 
}

.nav-item {
  padding: 16px 20px; 
  margin-bottom: 10px; 
  border-radius: var(--radius-lg); 
  cursor: pointer; 
  color: var(--text-muted);
  display: flex; 
  align-items: center; 
  gap: 15px; 
  transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
  font-weight: 600; 
  font-size: 14px;
}

.nav-item:hover { 
  background: #f1f5f9; 
  color: var(--primary); 
  transform: translateX(5px); 
}

.nav-item.active { 
  background: var(--primary-light); 
  color: var(--primary); 
  box-shadow: 0 4px 12px rgba(0,102,255,0.1); 
}

.main { 
  flex: 1; 
  padding: 45px; 
  overflow-y: auto; 
  display: flex; 
  flex-direction: column; 
}

.header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 40px; 
}

.header h1 { 
  font-size: 32px; 
  font-weight: 800; 
  margin: 0; 
  letter-spacing: -1px; 
}

.main-section { 
  display: none; 
  flex-direction: column; 
  height: 100%; 
  animation: slideIn 0.5s ease-out; 
}

.main-section.active { display: flex; }

#calendar { 
  background: var(--white); 
  padding: 30px; 
  border-radius: var(--radius-xl); 
  box-shadow: var(--shadow-lg); 
  flex: 1; 
  border: 1px solid rgba(255,255,255,0.7); 
}

.glass-card { 
  background: var(--white); 
  padding: 35px; 
  border-radius: var(--radius-xl); 
  box-shadow: var(--shadow-lg); 
  border: 1px solid var(--border); 
}

.btn-pro {
  background: #25D366; 
  color: white; 
  padding: 14px 28px; 
  border-radius: 60px; 
  text-decoration: none;
  font-weight: 700; 
  font-size: 14px; 
  border: none; 
  cursor: pointer; 
  display: flex; 
  align-items: center; 
  gap: 10px;
  box-shadow: 0 10px 20px rgba(37, 211, 102, 0.2); 
  transition: 0.3s;
}

.btn-pro:hover { 
  transform: translateY(-3px); 
  box-shadow: 0 15px 30px rgba(37, 211, 102, 0.3); 
}

.modal { 
  display: none; 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%; 
  background: rgba(15, 23, 42, 0.7); 
  z-index: 5000; 
  justify-content: center; 
  align-items: center; 
  backdrop-filter: blur(12px); 
}

.modal-content { 
  background: var(--white); 
  padding: 50px; 
  border-radius: 40px; 
  width: 750px; 
  max-width: 95%; 
  max-height: 90vh; 
  overflow-y: auto; 
  position: relative; 
  box-shadow: 0 40px 100px rgba(0,0,0,0.3); 
}

.form-group { margin-bottom: 30px; }

.form-group label { 
  display: block; 
  margin-bottom: 12px; 
  font-size: 13px; 
  font-weight: 800; 
  color: var(--text-muted); 
  text-transform: uppercase; 
  letter-spacing: 1px; 
}

input, select, textarea {
  width: 100%; 
  padding: 16px; 
  border: 1px solid var(--border); 
  border-radius: 16px;
  font-size: 16px; 
  box-sizing: border-box; 
  background: #fdfdfd; 
  transition: 0.3s;
}

input:focus, textarea:focus { 
  border-color: var(--primary); 
  outline: none; 
  background: white; 
  box-shadow: 0 0 0 5px var(--primary-light); 
}

.tabs { 
  display: flex; 
  gap: 40px; 
  margin-bottom: 35px; 
  border-bottom: 2px solid #f1f5f9; 
}

.tab-btn {
  padding: 15px 0; 
  border: none; 
  background: none; 
  color: var(--text-muted); 
  cursor: pointer;
  font-weight: 700; 
  font-size: 15px; 
  border-bottom: 4px solid transparent; 
  transition: 0.3s;
}

.tab-btn.active { 
  color: var(--primary); 
  border-bottom-color: var(--primary); 
}

.voice-hub { 
  background: #f8fafc; 
  border-radius: 24px; 
  padding: 35px; 
  margin-bottom: 25px; 
  border: 2px solid #f1f5f9; 
  text-align: center; 
}

#btnMicro {
  width: 80px; 
  height: 80px; 
  border-radius: 50%; 
  border: none; 
  background: var(--primary);
  color: white; 
  cursor: pointer; 
  font-size: 32px; 
  display: flex; 
  align-items: center;
  justify-content: center; 
  margin: 0 auto 25px; 
  box-shadow: 0 15px 35px rgba(0,102,255,0.4); 
  transition: 0.4s;
}

#btnMicro.recording { 
  background: var(--danger); 
  animation: pulse-red 1.5s infinite; 
  transform: scale(1.1); 
}

@keyframes pulse-red { 
  0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 
  70% { box-shadow: 0 0 0 25px rgba(239, 68, 68, 0); } 
  100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } 
}

table { 
  width: 100%; 
  border-collapse: separate; 
  border-spacing: 0 15px; 
}

th { 
  padding: 15px; 
  text-align: left; 
  color: #94a3b8; 
  font-size: 12px; 
  font-weight: 800; 
  text-transform: uppercase; 
}

td { 
  padding: 25px 20px; 
  background: white; 
  border-top: 1px solid #f1f5f9; 
  border-bottom: 1px solid #f1f5f9; 
  font-weight: 500; 
}

tr td:first-child { 
  border-left: 1px solid #f1f5f9; 
  border-top-left-radius: 20px; 
  border-bottom-left-radius: 20px; 
}

tr td:last-child { 
  border-right: 1px solid #f1f5f9; 
  border-top-right-radius: 20px; 
  border-bottom-right-radius: 20px; 
}

@keyframes slideIn { 
  from { opacity: 0; transform: translateY(20px); } 
  to { opacity: 1; transform: translateY(0); } 
}

.btn-save {
  background: var(--success);
  color: white;
  padding: 18px;
  border: none;
  border-radius: 16px;
  font-weight: 800;
  font-size: 16px;
  cursor: pointer;
  transition: 0.3s;
}

.btn-save:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
}

.btn-cancel {
  background: #f1f5f9;
  color: var(--text-muted);
  padding: 18px;
  border: none;
  border-radius: 16px;
  font-weight: 800;
  font-size: 16px;
  cursor: pointer;
  transition: 0.3s;
}

.btn-cancel:hover {
  background: #e2e8f0;
}
</style>
</head>
<body>

<div class="sidebar">
    <div class="logo-box"><div class="logo-icon"></div> FisioTool <span style="font-size: 10px; background: #eee; padding: 2px 8px; border-radius: 6px; color: #666; margin-left: 8px;">PRO</span></div>
    
    <div class="nav-group">
        <div class="nav-label">Panel Operativo</div>
        <div class="nav-item active" role="button" tabindex="0" aria-label="Bot√≥n: Abrir Agenda Semanal" id="nav-agenda" onclick="showSection('agenda')">üìÖ Agenda Visual</div>
        <div class="nav-item" role="button" tabindex="0" aria-label="Bot√≥n: Ver base de datos de pacientes" id="nav-pacientes" onclick="showSection('pacientes')">üë• CRM Pacientes</div>
        <div class="nav-item" role="button" tabindex="0" aria-label="Bot√≥n: Ver balance econ√≥mico y ganancias" id="nav-finanzas" onclick="showSection('finanzas')">üìà Balance y Ganancias</div>
    </div>

    <div class="nav-group">
        <div class="nav-label">Crecimiento</div>
        <div class="nav-item" role="button" tabindex="0" aria-label="Bot√≥n: Gestionar cobros y bonos" id="nav-bonos" onclick="showSection('bonos')">üéüÔ∏è Gesti√≥n de Bonos</div>
        <div class="nav-item" role="button" tabindex="0" aria-label="Bot√≥n: Ver enlace de referido" id="nav-afiliados" onclick="showSection('afiliados')">üíé Link de Afiliado</div>
    </div>

    <div class="nav-group">
        <div class="nav-label">Mejora Continua</div>
        <div class="nav-item" role="button" tabindex="0" aria-label="Bot√≥n: Enviar sugerencia de mejora" id="nav-sugerencias" onclick="showSection('sugerencias')">üí° Sugerencias Pro</div>
    </div>

    <div class="nav-group" style="margin-top: auto;">
        <div class="nav-item" role="button" tabindex="0" aria-label="Bot√≥n: Configurar vacaciones y bloqueos" id="nav-bloqueos" onclick="showSection('bloqueos')">üõ°Ô∏è Bloqueos</div>
        <div class="nav-item" role="button" tabindex="0" aria-label="Bot√≥n: Configurar sedes y ajustes" id="nav-ajustes" onclick="showSection('ajustes')">‚öôÔ∏è Ajustes</div>
    </div>
</div>

<div class="main">
  <div class="header">
    <h1 id="titleDisplay">Agenda Semanal</h1>
    <div style="display:flex; gap:15px;">
      <button class="btn-pro" style="background:#000;" onclick="copyClinicLink()">üîó Enlace Citas</button>
    </div>
  </div>

  <!-- SECCI√ìN 1: AGENDA -->
  <div id="section-agenda" class="main-section active">
    <div id="calendar"></div>
  </div>

  <!-- SECCI√ìN 2: CRM PACIENTES -->
  <div id="section-pacientes" class="main-section">
    <div class="glass-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h3>Base de Datos Inteligente</h3>
        <button class="btn-pro" style="background:var(--primary); font-size:12px;" onclick="document.getElementById('fileUpload').click()">üìÅ Cargar Base de Datos (CSV)</button>
        <input type="file" id="fileUpload" style="display:none;" onchange="handleFileUpload(this)">
      </div>
      <div id="pacientesLista">
        <p style="text-align:center; color:#94a3b8;">Cargando historial de pacientes...</p>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN 3: BONOS -->
  <div id="section-bonos" class="main-section">
    <div class="glass-card">
      <h3>Venta y Control de Bonos</h3>
      <p style="color:var(--text-muted); font-size:15px; margin-bottom:30px;">Asigna sesiones prepagadas a tus pacientes para que Ana gestione el saldo autom√°ticamente.</p>
      <div id="listaBonosTable">
        <p style="text-align:center; color:#94a3b8;">M√≥dulo en desarrollo...</p>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN 4: AFILIADOS -->
  <div id="section-afiliados" class="main-section">
    <div class="glass-card" style="text-align:center; padding:80px 40px;">
      <div style="font-size:70px; margin-bottom:30px;">üíé</div>
      <h2>Programa de Recomendaci√≥n</h2>
      <p style="color:var(--text-muted); max-width:500px; margin: 0 auto 40px; font-size:16px;">Comparte tu √©xito. Por cada colega que se registre con tu enlace, aplicaremos un <strong>50% de descuento</strong> a ambos de por vida.</p>
      <div id="refLink" style="background:var(--bg-body); padding:25px; border-radius:20px; font-family:monospace; font-weight:800; font-size:18px; margin-bottom:30px; border:2px dashed var(--border);">...</div>
      <button class="btn-pro" style="margin:0 auto; padding:18px 40px;" onclick="copyReferral()">COPIAR MI ENLACE</button>
    </div>
  </div>

  <!-- SECCI√ìN 5: AJUSTES / SEDES -->
  <div id="section-ajustes" class="main-section">
    <div class="glass-card" style="margin-bottom:30px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>üè¢ Sedes y Localizaciones</h3>
        <button class="btn-pro" style="background:var(--text-dark);" onclick="alert('Funcionalidad para a√±adir nueva direcci√≥n')">+ A√±adir Sede</button>
      </div>
      <div id="sedesGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:25px;"></div>
    </div>
    
    <!-- BLOQUE FINANCIERO PRO -->
    <div class="glass-card" style="margin-bottom:30px; border-left: 6px solid #6366f1;">
        <h3>üí≥ Configuraci√≥n de Cobros (Anti No-Show)</h3>
        <p style="color:var(--text-muted); font-size:14px; margin-bottom:25px;">Configura d√≥nde quieres recibir los pagos de las fianzas que Ana cobra a tus pacientes.</p>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
            <div class="form-group">
                <label>ID de Cuenta Stripe (sk_live...)</label>
                <input type="text" id="stripeId" placeholder="Introduce tu ID de Stripe">
            </div>
            <div class="form-group">
                <label>Fianza por Reserva (‚Ç¨)</label>
                <input type="number" id="fianzaVal" value="15">
            </div>
        </div>
        
        <div style="background:#f8fafc; padding:20px; border-radius:15px; margin-bottom:20px; border:1px solid #e2e8f0;">
            <label style="font-size:11px; color:#64748b; font-weight:800; text-transform:uppercase;">Respaldo Bancario (Transferencia)</label>
            <div style="display:grid; grid-template-columns:2fr 1fr; gap:15px; margin-top:10px;">
                <input type="text" id="ibanVal" placeholder="IBAN (ES00 0000...)">
                <input type="text" id="titularVal" placeholder="Titular de la cuenta">
            </div>
        </div>
        
        <button class="btn-pro" style="background:#6366f1; width:100%;" onclick="guardarFinanzas()">ACTUALIZAR DATOS DE COBRO ‚ûú</button>
    </div>
    
    <div class="glass-card">
      <h3>üõ°Ô∏è Seguridad y GDPR</h3>
      <div style="padding:15px; background:var(--primary-light); border-radius:15px; border-left:5px solid var(--primary);">
        <p style="font-size:14px; margin:0;"><strong>Estatus Legal:</strong> Todos tus pacientes han aceptado los t√©rminos de tratamiento de datos al registrarse con la IA.</p>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN 6: SUGERENCIAS -->
  <div id="section-sugerencias" class="main-section">
      <div class="glass-card" style="max-width: 800px; margin: 0 auto;">
          <h3>üöÄ Buz√≥n de Innovaci√≥n FisioTool</h3>
          <p style="color:var(--text-muted); margin-bottom:30px;">Tu feedback es el motor que hace que esta herramienta sea l√≠der. ¬øQu√© funcionalidad te gustar√≠a ver en el futuro?</p>
          
          <div class="form-group">
              <label>Describe tu idea o sugerencia de mejora</label>
              <textarea id="sugerenciaTxt" rows="8" placeholder="Ej: Me gustar√≠a que Ana pudiera enviar mensajes de audio..." style="background:#f8fafc; border:2px solid #f1f5f9;"></textarea>
          </div>
          
          <button class="btn-pro" style="width:100%; background:var(--primary); margin-top:20px;" onclick="enviarSugerencia()">ENVIAR A DESARROLLO ‚ûú</button>
          
          <div id="statusSugerencia" style="margin-top:20px; text-align:center; font-weight:600; display:none;"></div>
      </div>
  </div>

  <!-- SECCI√ìN 7: BLOQUEOS -->
  <div id="section-bloqueos" class="main-section">
      <div class="glass-card">
          <h3>üõ°Ô∏è Bloqueo Soberano de Agenda</h3>
          <p style="color:var(--text-muted);">Configura tus vacaciones o festivos. Ana rechazar√° citas en este rango.</p>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
              <input type="date" id="blockStart">
              <input type="date" id="blockEnd">
          </div>
          <input type="text" id="blockMotivo" placeholder="Motivo (Vacaciones, Festivo local...)" style="margin-top:15px;">
          <button class="btn-pro" style="background:var(--danger); width:100%; margin-top:20px;" onclick="ejecutarBloqueo()">BLOQUEAR FECHAS ‚ûú</button>
      </div>
  </div>

  <!-- SECCI√ìN 8: FINANZAS -->
  <div id="section-finanzas" class="main-section">
      <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-bottom:40px;">
          <div class="glass-card" style="border-bottom: 5px solid var(--success);">
              <small style="color:var(--text-muted); font-weight:800;">INGRESOS REALES</small>
              <h2 id="ingReal" style="font-size:36px; margin:10px 0;">0‚Ç¨</h2>
          </div>
          <div class="glass-card" style="border-bottom: 5px solid var(--warning);">
              <small style="color:var(--text-muted); font-weight:800;">POTENCIAL (AMARILLO)</small>
              <h2 id="ingPot" style="font-size:36px; margin:10px 0;">0‚Ç¨</h2>
          </div>
          <div class="glass-card" style="border-bottom: 5px solid var(--primary);">
              <small style="color:var(--text-muted); font-weight:800;">RETORNO FISIOTOOL</small>
              <h2 id="roiVal" style="font-size:36px; margin:10px 0;">0%</h2>
          </div>
      </div>
      <div class="glass-card">
          <h3>üìä Rendimiento Mensual</h3>
          <p>Citas gestionadas con √©xito por Ana: <strong id="totalCitasExito">0</strong></p>
      </div>
  </div>
</div>

<!-- MODAL RESERVA MANUAL -->
<div id="modalManual" class="modal">
  <div class="modal-content">
    <h2 style="margin-top:0">Reserva Manual</h2>
    <form id="formManual">
      <input type="hidden" id="manualDate">
      <div class="form-group"><label>Nombre Completo</label><input type="text" id="mNombre" required></div>
      <div class="form-group"><label>Tel√©fono Contacto</label><input type="text" id="mTlf"></div>
      <div class="form-group"><label>Notas Cl√≠nicas Previas</label><textarea id="mNotas" rows="2"></textarea></div>
      <div style="display:flex; gap:20px;">
        <button type="button" class="btn-cancel" style="flex:1" onclick="closeModal('modalManual')">Cancelar</button>
        <button type="submit" class="btn-save" style="flex:2">Agendar Ahora</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL FICHA DE PACIENTE -->
<div id="modalFicha" class="modal">
  <div class="modal-content" style="width: 850px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:35px;">
      <h2 style="margin:0">Ficha Cl√≠nica Digital</h2>
      <button onclick="closeModal('modalFicha')" style="background:none; border:none; font-size:40px; cursor:pointer; color:#cbd5e1;">&times;</button>
    </div>

    <div style="background:linear-gradient(135deg, #0066ff, #0044aa); padding:35px; border-radius:30px; margin-bottom:40px; display:flex; justify-content:space-between; align-items:center; color:white; box-shadow: 0 15px 30px rgba(0,102,255,0.2);">
      <div>
        <h3 id="fName" style="margin:0; font-size:24px; font-weight:800;">...</h3>
        <span id="fTlf" style="font-size:15px; opacity:0.8; font-weight:500;"></span>
      </div>
      <div id="fBonoTag" style="background:rgba(255,255,255,0.2); padding:12px 25px; border-radius:15px; font-size:13px; font-weight:800; border:1px solid rgba(255,255,255,0.3);">üéüÔ∏è BONO ACTIVO</div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab(this, 'notas')">üìù Evoluci√≥n M√©dica</button>
      <button class="tab-btn" onclick="switchTab(this, 'chat')">üí¨ Historial Chat IA</button>
      <button class="tab-btn" onclick="switchTab(this, 'pagos')">üí≥ Pagos y Bonos</button>
    </div>

    <div id="tab-notas" class="tab-pane">
      <div class="voice-hub">
        <button id="btnMicro" onclick="toggleVoice()">üé§</button>
        <p id="micStatus" style="font-size:12px; font-weight:800; color:var(--danger); visibility:hidden;">üî¥ GRABANDO... HABLA AHORA</p>
        <label style="display:block; text-align:left; margin-bottom:12px; color:var(--text-gray);">TRANSCRIPCI√ìN EN TIEMPO REAL (Edita antes de guardar):</label>
        <textarea id="voiceResult" rows="6" style="background:white; border:2px solid #f1f5f9; font-weight:500;" placeholder="Pulsa el micro para dictar la evoluci√≥n del paciente..."></textarea>
      </div>
      <div style="display:flex; gap:20px;">
        <button onclick="saveNote()" style="flex:2; background:var(--success); color:white; padding:18px; font-size:16px; border:none; border-radius:16px; font-weight:800; cursor:pointer;">‚úÖ VALIDAR Y GUARDAR EN HISTORIAL</button>
        <button onclick="document.getElementById('voiceResult').value=''" style="flex:1; background:#f1f5f9; color:var(--text-muted); padding:18px; border:none; border-radius:16px; font-weight:800; cursor