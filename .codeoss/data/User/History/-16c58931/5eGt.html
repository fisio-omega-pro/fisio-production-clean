<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FisioTool Pro - Gesti√≥n de √âlite</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/es.global.min.js'></script>

<style>
:root {
--primary: #0066ff;
--primary-dark: #0052cc;
--primary-light: #eef5ff;
--success: #10b981;
--danger: #ef4444;
--warning: #f59e0b;
--bg-body: #f8fafc;
--white: #ffffff;
--text-main: #0f172a;
--text-muted: #64748b;
--border: #e2e8f0;
--radius-xl: 32px;
--radius-lg: 24px;
--shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
--shadow-md: 0 10px 15px -3px rgba(0,0,0,0.05);
--shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1);
}

body { 
  font-family: 'Inter', sans-serif; 
  background: var(--bg-body); 
  margin: 0; 
  display: flex; 
  height: 100vh; 
  color: var(--text-main); 
  overflow: hidden; 
}

.sidebar {
  width: 300px; 
  background: var(--white); 
  border-right: 1px solid var(--border);
  display: flex; 
  flex-direction: column; 
  padding: 40px 30px; 
  box-sizing: border-box;
  box-shadow: 10px 0 30px rgba(0,0,0,0.02);
}

.logo-box { 
  font-size: 26px; 
  font-weight: 800; 
  color: var(--primary); 
  margin-bottom: 50px; 
  display: flex; 
  align-items: center; 
  gap: 15px; 
  letter-spacing: -1px; 
}

.logo-icon { 
  width: 16px; 
  height: 16px; 
  background: var(--primary); 
  border-radius: 5px; 
  box-shadow: 0 0 15px var(--primary); 
}
<div class="nav-item" id="nav-bloqueos" onclick="showSection('bloqueos')">üõ°Ô∏è Bloqueos / Vacaciones</div>
.nav-group { margin-bottom: 35px; }

.nav-label { 
  font-size: 11px; 
  font-weight: 800; 
  color: #94a3b8; 
  text-transform: uppercase; 
  letter-spacing: 1.5px; 
  margin-bottom: 15px; 
  padding-left: 10px; 
}

.nav-item {
  padding: 16px 20px; 
  margin-bottom: 10px; 
  border-radius: var(--radius-lg); 
  cursor: pointer; 
  color: var(--text-muted);
  display: flex; 
  align-items: center; 
  gap: 15px; 
  transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
  font-weight: 600; 
  font-size: 14px;
}

.nav-item:hover { 
  background: #f1f5f9; 
  color: var(--primary); 
  transform: translateX(5px); 
}

.nav-item.active { 
  background: var(--primary-light); 
  color: var(--primary); 
  box-shadow: 0 4px 12px rgba(0,102,255,0.1); 
}

.main { 
  flex: 1; 
  padding: 45px; 
  overflow-y: auto; 
  display: flex; 
  flex-direction: column; 
}

.header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 40px; 
}

.header h1 { 
  font-size: 32px; 
  font-weight: 800; 
  margin: 0; 
  letter-spacing: -1px; 
}

.main-section { 
  display: none; 
  flex-direction: column; 
  height: 100%; 
  animation: slideIn 0.5s ease-out; 
}

.main-section.active { display: flex; }

#calendar { 
  background: var(--white); 
  padding: 30px; 
  border-radius: var(--radius-xl); 
  box-shadow: var(--shadow-lg); 
  flex: 1; 
  border: 1px solid rgba(255,255,255,0.7); 
}

.glass-card { 
  background: var(--white); 
  padding: 35px; 
  border-radius: var(--radius-xl); 
  box-shadow: var(--shadow-lg); 
  border: 1px solid var(--border); 
}

.btn-pro {
  background: #25D366; 
  color: white; 
  padding: 14px 28px; 
  border-radius: 60px; 
  text-decoration: none;
  font-weight: 700; 
  font-size: 14px; 
  border: none; 
  cursor: pointer; 
  display: flex; 
  align-items: center; 
  gap: 10px;
  box-shadow: 0 10px 20px rgba(37, 211, 102, 0.2); 
  transition: 0.3s;
}

.btn-pro:hover { 
  transform: translateY(-3px); 
  box-shadow: 0 15px 30px rgba(37, 211, 102, 0.3); 
}

.modal { 
  display: none; 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%; 
  background: rgba(15, 23, 42, 0.7); 
  z-index: 5000; 
  justify-content: center; 
  align-items: center; 
  backdrop-filter: blur(12px); 
}

.modal-content { 
  background: var(--white); 
  padding: 50px; 
  border-radius: 40px; 
  width: 750px; 
  max-width: 95%; 
  max-height: 90vh; 
  overflow-y: auto; 
  position: relative; 
  box-shadow: 0 40px 100px rgba(0,0,0,0.3); 
}

.form-group { margin-bottom: 30px; }

.form-group label { 
  display: block; 
  margin-bottom: 12px; 
  font-size: 13px; 
  font-weight: 800; 
  color: var(--text-muted); 
  text-transform: uppercase; 
  letter-spacing: 1px; 
}

input, select, textarea {
  width: 100%; 
  padding: 16px; 
  border: 1px solid var(--border); 
  border-radius: 16px;
  font-size: 16px; 
  box-sizing: border-box; 
  background: #fdfdfd; 
  transition: 0.3s;
}

input:focus, textarea:focus { 
  border-color: var(--primary); 
  outline: none; 
  background: white; 
  box-shadow: 0 0 0 5px var(--primary-light); 
}

.tabs { 
  display: flex; 
  gap: 40px; 
  margin-bottom: 35px; 
  border-bottom: 2px solid #f1f5f9; 
}

.tab-btn {
  padding: 15px 0; 
  border: none; 
  background: none; 
  color: var(--text-muted); 
  cursor: pointer;
  font-weight: 700; 
  font-size: 15px; 
  border-bottom: 4px solid transparent; 
  transition: 0.3s;
}

.tab-btn.active { 
  color: var(--primary); 
  border-bottom-color: var(--primary); 
}

.voice-hub { 
  background: #f8fafc; 
  border-radius: 24px; 
  padding: 35px; 
  margin-bottom: 25px; 
  border: 2px solid #f1f5f9; 
  text-align: center; 
}

#btnMicro {
  width: 80px; 
  height: 80px; 
  border-radius: 50%; 
  border: none; 
  background: var(--primary);
  color: white; 
  cursor: pointer; 
  font-size: 32px; 
  display: flex; 
  align-items: center;
  justify-content: center; 
  margin: 0 auto 25px; 
  box-shadow: 0 15px 35px rgba(0,102,255,0.4); 
  transition: 0.4s;
}

#btnMicro.recording { 
  background: var(--danger); 
  animation: pulse-red 1.5s infinite; 
  transform: scale(1.1); 
}

@keyframes pulse-red { 
  0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 
  70% { box-shadow: 0 0 0 25px rgba(239, 68, 68, 0); } 
  100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } 
}

table { 
  width: 100%; 
  border-collapse: separate; 
  border-spacing: 0 15px; 
}

th { 
  padding: 15px; 
  text-align: left; 
  color: #94a3b8; 
  font-size: 12px; 
  font-weight: 800; 
  text-transform: uppercase; 
}

td { 
  padding: 25px 20px; 
  background: white; 
  border-top: 1px solid #f1f5f9; 
  border-bottom: 1px solid #f1f5f9; 
  font-weight: 500; 
}

tr td:first-child { 
  border-left: 1px solid #f1f5f9; 
  border-top-left-radius: 20px; 
  border-bottom-left-radius: 20px; 
}

tr td:last-child { 
  border-right: 1px solid #f1f5f9; 
  border-top-right-radius: 20px; 
  border-bottom-right-radius: 20px; 
}

@keyframes slideIn { 
  from { opacity: 0; transform: translateY(20px); } 
  to { opacity: 1; transform: translateY(0); } 
}

.btn-save {
  background: var(--success);
  color: white;
  padding: 18px;
  border: none;
  border-radius: 16px;
  font-weight: 800;
  font-size: 16px;
  cursor: pointer;
  transition: 0.3s;
}

.btn-save:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
}

.btn-cancel {
  background: #f1f5f9;
  color: var(--text-muted);
  padding: 18px;
  border: none;
  border-radius: 16px;
  font-weight: 800;
  font-size: 16px;
  cursor: pointer;
  transition: 0.3s;
}

.btn-cancel:hover {
  background: #e2e8f0;
}
</style>
</head>
<body>

<div class="sidebar">
    <div class="logo-box"><div class="logo-icon"></div> FisioTool <span style="font-size: 10px; background: #eee; padding: 2px 8px; border-radius: 6px; color: #666; margin-left: 8px;">PRO</span></div>
    
    <!-- GRUPO 1: GESTI√ìN DIARIA -->
    <div class="nav-group">
        <div class="nav-label">Panel Operativo</div>
        <div class="nav-item active" role="button" tabindex="0" aria-label="Bot√≥n: Abrir Agenda Semanal" id="nav-agenda" onclick="showSection('agenda')">
            üìÖ Agenda Visual
        </div>
        <div class="nav-item" role="button" tabindex="0" aria-label="Bot√≥n: Ver base de datos de pacientes" id="nav-pacientes" onclick="showSection('pacientes')">
            üë• CRM Pacientes
        </div>
        <div class="nav-item" role="button" tabindex="0" aria-label="Bot√≥n: Ver balance econ√≥mico y ganancias" id="nav-finanzas" onclick="showSection('finanzas')">
            üìà Balance y Ganancias
        </div>
    </div>

    <!-- GRUPO 2: CRECIMIENTO Y VENTAS -->
    <div class="nav-group">
        <div class="nav-label">Crecimiento</div>
        <div class="nav-item" role="button" tabindex="0" aria-label="Bot√≥n: Gestionar cobros y bonos de sesiones" id="nav-bonos" onclick="showSection('bonos')">
            üéüÔ∏è Gesti√≥n de Bonos
        </div>
        <div class="nav-item" role="button" tabindex="0" aria-label="Bot√≥n: Ver enlace de referido y premios" id="nav-afiliados" onclick="showSection('afiliados')">
            üíé Link de Afiliado
        </div>
    </div>

    <!-- GRUPO 3: INNOVACI√ìN -->
    <div class="nav-group">
        <div class="nav-label">Mejora Continua</div>
        <div class="nav-item" role="button" tabindex="0" aria-label="Bot√≥n: Enviar sugerencia de mejora" id="nav-sugerencias" onclick="showSection('sugerencias')">
            üí° Sugerencias Pro
        </div>
    </div>

    <!-- GRUPO 4: CONFIGURACI√ìN (AL FINAL) -->
    <div class="nav-group" style="margin-top: auto;">
        <div class="nav-item" role="button" tabindex="0" aria-label="Bot√≥n: Configurar vacaciones y bloqueos de agenda" id="nav-bloqueos" onclick="showSection('bloqueos')">
            üõ°Ô∏è Bloqueos
        </div>
        <div class="nav-item" role="button" tabindex="0" aria-label="Bot√≥n: Configurar sedes y datos de la cl√≠nica" id="nav-ajustes" onclick="showSection('ajustes')">
            ‚öôÔ∏è Sedes y Ajustes
        </div>
    </div>
</div>
<div class="main">
  <div class="header">
    <h1 id="titleDisplay">Agenda Semanal</h1>
    <div style="display:flex; gap:15px;">
      <button class="btn-pro" style="background:#000;" onclick="copyClinicLink()">üîó Enlace Citas</button>
    </div>
  </div>

  <!-- SECCI√ìN 1: AGENDA -->
  <div id="section-agenda" class="main-section active">
    <div id="calendar"></div>
  </div>

  <!-- SECCI√ìN 2: CRM PACIENTES -->
  <div id="section-pacientes" class="main-section">
    <div class="glass-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h3>Base de Datos Inteligente</h3>
        <button class="btn-pro" style="background:var(--primary); font-size:12px;" onclick="document.getElementById('fileUpload').click()">üìÅ Cargar Base de Datos (CSV)</button>
        <input type="file" id="fileUpload" style="display:none;" onchange="handleFileUpload(this)">
      </div>
      <div id="pacientesLista">
        <p style="text-align:center; color:#94a3b8;">Cargando historial de pacientes...</p>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN 3: BONOS -->
  <div id="section-bonos" class="main-section">
    <div class="glass-card">
      <h3>Venta y Control de Bonos</h3>
      <p style="color:var(--text-muted); font-size:15px; margin-bottom:30px;">Asigna sesiones prepagadas a tus pacientes para que Ana gestione el saldo autom√°ticamente.</p>
      <div id="listaBonosTable">
        <p style="text-align:center; color:#94a3b8;">M√≥dulo en desarrollo...</p>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN 4: AFILIADOS -->
  <div id="section-afiliados" class="main-section">
    <div class="glass-card" style="text-align:center; padding:80px 40px;">
      <div style="font-size:70px; margin-bottom:30px;">üíé</div>
      <h2>Programa de Recomendaci√≥n</h2>
      <p style="color:var(--text-muted); max-width:500px; margin: 0 auto 40px; font-size:16px;">Comparte tu √©xito. Por cada colega que se registre con tu enlace, aplicaremos un <strong>50% de descuento</strong> a ambos de por vida.</p>
      <div id="refLink" style="background:var(--bg-body); padding:25px; border-radius:20px; font-family:monospace; font-weight:800; font-size:18px; margin-bottom:30px; border:2px dashed var(--border);">...</div>
      <button class="btn-pro" style="margin:0 auto; padding:18px 40px;" onclick="copyReferral()">COPIAR MI ENLACE</button>
    </div>
  </div>

  <!-- SECCI√ìN 5: AJUSTES / SEDES -->
  <div id="section-ajustes" class="main-section">
    <div class="glass-card" style="margin-bottom:30px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>üè¢ Sedes y Localizaciones</h3>
        <button class="btn-pro" style="background:var(--text-dark);" onclick="alert('Funcionalidad para a√±adir nueva direcci√≥n')">+ A√±adir Sede</button>
      </div>
      <div id="sedesGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:25px;"></div>
    </div>
    <!-- BLOQUE FINANCIERO PRO -->
            <div class="glass-card" style="margin-bottom:30px; border-left: 6px solid #6366f1;">
                <h3>üí≥ Configuraci√≥n de Cobros (Anti No-Show)</h3>
                <p style="color:var(--text-muted); font-size:14px; margin-bottom:25px;">Configura d√≥nde quieres recibir los pagos de las fianzas que Ana cobra a tus pacientes.</p>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div class="form-group">
                        <label>ID de Cuenta Stripe (sk_live...)</label>
                        <input type="text" id="stripeId" placeholder="Introduce tu ID de Stripe">
                    </div>
                    <div class="form-group">
                        <label>Fianza por Reserva (‚Ç¨)</label>
                        <input type="number" id="fianzaVal" value="15">
                    </div>
                </div>
                
                <div style="background:#f8fafc; padding:20px; border-radius:15px; margin-bottom:20px; border:1px solid #e2e8f0;">
                    <label style="font-size:11px; color:#64748b; font-weight:800; text-transform:uppercase;">Respaldo Bancario (Transferencia)</label>
                    <div style="display:grid; grid-template-columns:2fr 1fr; gap:15px; margin-top:10px;">
                        <input type="text" id="ibanVal" placeholder="IBAN (ES00 0000...)">
                        <input type="text" id="titularVal" placeholder="Titular de la cuenta">
                    </div>
                </div>
                
                <button class="btn-pro" style="background:#6366f1; width:100%;" onclick="guardarFinanzas()">ACTUALIZAR DATOS DE COBRO ‚ûú</button>
            </div>
    <div class="glass-card">
      <h3>üõ°Ô∏è Seguridad y GDPR</h3>
      <div style="padding:15px; background:var(--primary-light); border-radius:15px; border-left:5px solid var(--primary);">
        <p style="font-size:14px; margin:0;"><strong>Estatus Legal:</strong> Todos tus pacientes han aceptado los t√©rminos de tratamiento de datos al registrarse con la IA.</p>
      </div>
    </div>
    <!-- SECCI√ìN 6: SUGERENCIAS -->
<div id="section-sugerencias" class="main-section">
    <div class="glass-card" style="max-width: 800px; margin: 0 auto;">
        <h3>üöÄ Buz√≥n de Innovaci√≥n FisioTool</h3>
        <p style="color:var(--text-muted); margin-bottom:30px;">Tu feedback es el motor que hace que esta herramienta sea l√≠der. ¬øQu√© funcionalidad te gustar√≠a ver en el futuro?</p>
        
        <div class="form-group">
            <label>Describe tu idea o sugerencia de mejora</label>
            <textarea id="sugerenciaTxt" rows="8" placeholder="Ej: Me gustar√≠a que Ana pudiera enviar mensajes de audio..." style="background:#f8fafc; border:2px solid #f1f5f9;"></textarea>
        </div>
        
        <button class="btn-pro" style="width:100%; background:var(--primary); margin-top:20px;" onclick="enviarSugerencia()">ENVIAR A DESARROLLO ‚ûú</button>
        
        <div id="statusSugerencia" style="margin-top:20px; text-align:center; font-weight:600; display:none;"></div>
    </div>
</div>
  </div>
</div>
<div id="section-bloqueos" class="main-section">
    <div class="glass-card">
        <h3>üõ°Ô∏è Bloqueo Soberano de Agenda</h3>
        <p style="color:var(--text-muted);">Configura tus vacaciones o festivos. Ana rechazar√° citas en este rango.</p>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
            <input type="date" id="blockStart">
            <input type="date" id="blockEnd">
        </div>
        <input type="text" id="blockMotivo" placeholder="Motivo (Vacaciones, Festivo local...)" style="margin-top:15px;">
        <button class="btn-pro" style="background:var(--danger); width:100%; margin-top:20px;" onclick="ejecutarBloqueo()">BLOQUEAR FECHAS ‚ûú</button>
    </div>
</div>
<div id="section-finanzas" class="main-section">
    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-bottom:40px;">
        <div class="glass-card" style="border-bottom: 5px solid var(--success);">
            <small style="color:var(--text-muted); font-weight:800;">INGRESOS REALES</small>
            <h2 id="ingReal" style="font-size:36px; margin:10px 0;">0‚Ç¨</h2>
        </div>
        <div class="glass-card" style="border-bottom: 5px solid var(--warning);">
            <small style="color:var(--text-muted); font-weight:800;">POTENCIAL (AMARILLO)</small>
            <h2 id="ingPot" style="font-size:36px; margin:10px 0;">0‚Ç¨</h2>
        </div>
        <div class="glass-card" style="border-bottom: 5px solid var(--primary);">
            <small style="color:var(--text-muted); font-weight:800;">RETORNO FISIOTOOL</small>
            <h2 id="roiVal" style="font-size:36px; margin:10px 0;">0%</h2>
        </div>
    </div>
    <div class="glass-card">
        <h3>üìä Rendimiento Mensual</h3>
        <p>Citas gestionadas con √©xito por Ana: <strong id="totalCitasExito">0</strong></p>
    </div>
</div>
<!-- MODAL RESERVA MANUAL -->
<div id="modalManual" class="modal">
  <div class="modal-content">
    <h2 style="margin-top:0">Reserva Manual</h2>
    <form id="formManual">
      <input type="hidden" id="manualDate">
      <div class="form-group"><label>Nombre Completo</label><input type="text" id="mNombre" required></div>
      <div class="form-group"><label>Tel√©fono Contacto</label><input type="text" id="mTlf"></div>
      <div class="form-group"><label>Notas Cl√≠nicas Previas</label><textarea id="mNotas" rows="2"></textarea></div>
      <div style="display:flex; gap:20px;">
        <button type="button" class="btn-cancel" style="flex:1" onclick="closeModal('modalManual')">Cancelar</button>
        <button type="submit" class="btn-save" style="flex:2">Agendar Ahora</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL FICHA DE PACIENTE -->
<div id="modalFicha" class="modal">
  <div class="modal-content" style="width: 850px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:35px;">
      <h2 style="margin:0">Ficha Cl√≠nica Digital</h2>
      <button onclick="closeModal('modalFicha')" style="background:none; border:none; font-size:40px; cursor:pointer; color:#cbd5e1;">&times;</button>
    </div>

    <div style="background:linear-gradient(135deg, #0066ff, #0044aa); padding:35px; border-radius:30px; margin-bottom:40px; display:flex; justify-content:space-between; align-items:center; color:white; box-shadow: 0 15px 30px rgba(0,102,255,0.2);">
      <div>
        <h3 id="fName" style="margin:0; font-size:24px; font-weight:800;">...</h3>
        <span id="fTlf" style="font-size:15px; opacity:0.8; font-weight:500;"></span>
      </div>
      <div id="fBonoTag" style="background:rgba(255,255,255,0.2); padding:12px 25px; border-radius:15px; font-size:13px; font-weight:800; border:1px solid rgba(255,255,255,0.3);">üéüÔ∏è BONO ACTIVO</div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab(this, 'notas')">üìù Evoluci√≥n M√©dica</button>
      <button class="tab-btn" onclick="switchTab(this, 'chat')">üí¨ Historial Chat IA</button>
      <button class="tab-btn" onclick="switchTab(this, 'pagos')">üí≥ Pagos y Bonos</button>
    </div>

    <div id="tab-notas" class="tab-pane">
      <div class="voice-hub">
        <button id="btnMicro" onclick="toggleVoice()">üé§</button>
        <p id="micStatus" style="font-size:12px; font-weight:800; color:var(--danger); visibility:hidden;">üî¥ GRABANDO... HABLA AHORA</p>
        <label style="display:block; text-align:left; margin-bottom:12px; color:var(--text-gray);">TRANSCRIPCI√ìN EN TIEMPO REAL (Edita antes de guardar):</label>
        <textarea id="voiceResult" rows="6" style="background:white; border:2px solid #f1f5f9; font-weight:500;" placeholder="Pulsa el micro para dictar la evoluci√≥n del paciente..."></textarea>
      </div>
      <div style="display:flex; gap:20px;">
        <button onclick="saveNote()" style="flex:2; background:var(--success); color:white; padding:18px; font-size:16px; border:none; border-radius:16px; font-weight:800; cursor:pointer;">‚úÖ VALIDAR Y GUARDAR EN HISTORIAL</button>
        <button onclick="document.getElementById('voiceResult').value=''" style="flex:1; background:#f1f5f9; color:var(--text-muted); padding:18px; border:none; border-radius:16px; font-weight:800; cursor:pointer;">Limpiar</button>
      </div>
      <div id="clinicalHistory" style="margin-top:40px;"></div>
    </div>

    <div id="tab-chat" class="tab-pane" style="display:none;">
      <div id="chatLog" style="max-height:450px; overflow-y:auto; padding:10px;"></div>
    </div>

    <div id="tab-pagos" class="tab-pane" style="display:none;">
    <div style="background:#f8fafc; border-radius:20px; padding:30px; text-align:center; border:2px dashed #e2e8f0;">
        <h4 style="margin-top:0">üéüÔ∏è Emisi√≥n de Bonos de Sesiones</h4>
        <p style="color:var(--text-muted); font-size:14px;">Al asignar un bono, Ana lo detectar√° y permitir√° al paciente reservar sin pagar fianza.</p>
        
        <div style="display:flex; gap:10px; justify-content:center; margin-bottom:20px;">
            <button onclick="asignarBono(5)" class="btn-pro" style="background:var(--primary);">+ Bono 5 Sesiones</button>
            <button onclick="asignarBono(10)" class="btn-pro" style="background:var(--text-main);">+ Bono 10 Sesiones</button>
        </div>
    </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const clinicId = params.get('id');
let calendar, recognition, curTlf, curNombre;

document.addEventListener('DOMContentLoaded', function() {
  if(!clinicId) { 
    document.body.innerHTML = "<div style='padding:100px; text-align:center;'><h1>403</h1><p>Acceso denegado. Se requiere Token de Cl√≠nica.</p></div>"; 
    return; 
  }

  initCalendar();
  initVoice();
  loadClinicData();
});

function initCalendar() {
  const el = document.getElementById('calendar');
  calendar = new FullCalendar.Calendar(el, {
    initialView: 'timeGridWeek',
    locale: 'es',
    firstDay: 1,
    buttonText: { today: 'Hoy', month: 'Mes', week: 'Semana', day: 'D√≠a', list: 'Lista' },
    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
    slotMinTime: '08:00:00', 
    slotMaxTime: '21:00:00', 
    allDaySlot: false, 
    height: '100%',
    nowIndicator: true,
    events: `/api/dashboard/calendar?clinic_id=${clinicId}`,
    dateClick: (info) => openManual(info.dateStr),
    eventClick: (info) => openFicha(info.event)
  });
  calendar.render();
}

function initVoice() {
  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.onresult = (e) => {
      let text = "";
      for (let i = e.resultIndex; i < e.results.length; i++) {
        text += e.results[i][0].transcript;
      }
      document.getElementById('voiceResult').value = text;
    };
  }
}

async function loadClinicData() {
  try {
    const res = await fetch(`/api/config/${clinicId}`);
    const data = await res.json();

    document.getElementById('refLink').innerText = `${window.location.origin}/setup?ref=${data.mi_codigo_referido || 'FT-PRO'}`;

    const sedes = data.direcciones || [];
    document.getElementById('sedesGrid').innerHTML = sedes.map(s => `
      <div style="background:#fff; border:1px solid #f1f5f9; padding:20px; border-radius:18px; position:relative;">
        <div style="font-size:12px; font-weight:800; color:var(--success); margin-bottom:10px;">SEDE PRINCIPAL</div>
        <div style="font-weight:700;">${s.calle} ${s.numero}</div>
        <div style="color:var(--text-muted); font-size:13px;">${s.cp}, ${s.ciudad}</div>
      </div>
    `).join('');
  } catch(e) {
    console.error("Error cargando config:", e);
  }
}

function showSection(id) {
  document.querySelectorAll('.main-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('section-' + id).classList.add('active');
  document.getElementById('nav-' + id).classList.add('active');

  const titles = { 
    agenda: 'Agenda Semanal', 
    pacientes: 'Base de Datos de Pacientes', 
    bonos: 'Gesti√≥n de Bonos', 
    afiliados: 'Programa Afiliados', 
    ajustes: 'Sedes y Ajustes' 
  };
  document.getElementById('titleDisplay').innerText = titles[id];
  
  if(id === 'pacientes') loadCRM();
}

function switchTab(btn, id) {
  document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + id).style.display = 'block';
  btn.classList.add('active');
}

async function loadCRM() {
  const container = document.getElementById('pacientesLista');
  try {
    const res = await fetch(`/api/dashboard/pacientes?clinic_id=${clinicId}`);
    const data = await res.json();
    
    if(!data.length) { 
      container.innerHTML = '<p style="text-align:center; padding:40px; color:#94a3b8;">No hay pacientes registrados a√∫n.</p>'; 
      return; 
    }

    let h = '<table><thead><tr><th>PACIENTE</th><th>TEL√âFONO</th><th>√öLTIMA VISITA</th><th>ACCIONES</th></tr></thead><tbody>';
    data.forEach(p => {
      h += `<tr>
        <td style="font-weight:700;">${p.nombre}</td>
        <td>${p.telefono}</td>
        <td>${new Date(p.ultimaCita).toLocaleDateString()}</td>
        <td style="text-align:right;">
          <button onclick="openFichaManual('${p.telefono}', '${p.nombre}')" style="background:var(--primary-light); color:var(--primary); border:none; padding:10px 20px; border-radius:12px; font-weight:700; cursor:pointer;">VER FICHA</button>
        </td>
      </tr>`;
    });
    container.innerHTML = h + '</tbody></table>';
  } catch(e) { 
    container.innerHTML = 'Error de conexi√≥n.'; 
    console.error("Error CRM:", e);
  }
}

function openFicha(ev) { 
  openFichaManual(ev.extendedProps.telefono, ev.title.replace(/\(.*\)/, '').trim()); 
}

function openFichaManual(tlf, nombre) {
  curTlf = tlf; 
  curNombre = nombre;
  document.getElementById('modalFicha').style.display = 'flex';
  document.getElementById('fName').innerText = nombre;
  document.getElementById('fTlf').innerText = 'üìû ' + tlf;
  document.getElementById('voiceResult').value = "";
  switchTab(document.querySelector('.tab-btn'), 'notas');
  loadFichaData();
}

async function loadFichaData() {
  const hBox = document.getElementById('clinicalHistory');
  const cBox = document.getElementById('chatLog');
  hBox.innerHTML = '<p style="text-align:center;">Cargando historial m√©dico...</p>';

  try {
    const tlfLimpio = curTlf.replace(/\s+/g, '').replace('+34', '');
    const res = await fetch(`/api/dashboard/paciente-info?clinic_id=${clinicId}&telefono=${tlfLimpio}`);
    const data = await res.json();

    // Renderizado de Notas Cl√≠nicas (Dictadas por voz)
    hBox.innerHTML = data.notas.length ? data.notas.map(n => `
      <div style="background:#fff; border:1px solid #f1f5f9; padding:20px; border-radius:18px; margin-bottom:12px; border-left:6px solid var(--success); box-shadow:var(--shadow-sm);">
        <small style="font-weight:800; color:var(--primary);">${new Date(n.creado).toLocaleString('es-ES')}</small>
        <p style="margin:10px 0 0 0; line-height:1.6; font-size:15px; color:#334155;">${n.contenido}</p>
      </div>
    `).join('') : '<p style="text-align:center; font-size:13px; color:#94a3b8; padding:20px;">Este paciente a√∫n no tiene notas de evoluci√≥n m√©dica.</p>';

    // Renderizado de Chat Log con Ana
    cBox.innerHTML = data.chats.length ? data.chats.map(c => `
      <div style="margin-bottom:20px; display:flex; flex-direction:column; gap:8px;">
        <div style="align-self:flex-end; background:var(--primary-light); color:var(--primary); padding:12px 18px; border-radius:18px 18px 0 18px; font-size:14px; font-weight:500;">${c.msg}</div>
        <div style="align-self:flex-start; background:#f1f5f9; color:var(--text-dark); padding:12px 18px; border-radius:18px 18px 18px 0; font-size:14px; border:1px solid #e2e8f0;">${c.reply}</div>
      </div>
    `).join('') : '<p style="text-align:center; font-size:13px; color:#94a3b8; padding:20px;">No hay historial de conversaciones con Ana.</p>';
    
  } catch(e) {
    console.error("Error cargando ficha:", e);
    hBox.innerHTML = '<p style="color:red; text-align:center;">Error al conectar con la base de datos.</p>';
  }
}

async function saveNote() {
  const t = document.getElementById('voiceResult').value;
  if(!t.trim()) return alert("La nota est√° vac√≠a.");
  
  const btn = event.target; 
  btn.disabled = true; 
  btn.innerText = "Guardando...";

  try {
    await fetch('/api/dashboard/guardar-nota', { 
      method: 'POST',
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify({ 
        clinic_id: clinicId, 
        telefono: curTlf, 
        nombre: curNombre, 
        texto: t 
      }) 
    });

    btn.disabled = false; 
    btn.innerText = "‚úÖ VALIDAR Y GUARDAR EN HISTORIAL";
    document.getElementById('voiceResult').value = ""; 
    loadFichaData();
    alert("‚úÖ Nota guardada correctamente");
  } catch(e) {
    console.error("Error guardando nota:", e);
    btn.disabled = false;
    alert("Error al guardar la nota");
  }
}

function openManual(d) {
  document.getElementById('modalManual').style.display = 'flex';
  document.getElementById('manualDate').value = d;
}

function closeModal(id) { 
  document.getElementById(id).style.display = 'none'; 
}

function copyClinicLink() {
  navigator.clipboard.writeText(`${window.location.origin}/${clinicId}`);
  alert("‚úÖ Enlace para pacientes copiado.");
}

function copyReferral() {
  navigator.clipboard.writeText(document.getElementById('refLink').innerText);
  alert("üíé Enlace de afiliado copiado.");
}

document.getElementById('formManual').addEventListener('submit', async (e) => {
  e.preventDefault();

  try {
    await fetch('/api/dashboard/cita-manual', { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify({
        clinic_id: clinicId, 
        fecha: document.getElementById('manualDate').value, 
        nombre: document.getElementById('mNombre').value, 
        telefono: document.getElementById('mTlf').value, 
        notas: document.getElementById('mNotas').value 
      }) 
    });

    closeModal('modalManual'); 
    calendar.refetchEvents();
    e.target.reset();
    alert("‚úÖ Cita creada correctamente");
  } catch(e) {
    console.error("Error creando cita:", e);
    alert("Error al crear la cita");
  }
});

async function handleFileUpload(input) {
    const file = input.files[0];
    if (!file) return;

    // Validaci√≥n de formato
    if (!file.name.endsWith('.csv')) {
        alert("‚ùå Por favor, sube un archivo en formato .csv");
        return;
    }

    const reader = new FileReader();
    reader.onload = async (e) => {
        const text = e.target.result;
        const rows = text.split('\n').slice(1); // Ignoramos la cabecera (Nombre, Telefono, Email)
        const pacientes = [];

        rows.forEach(row => {
            const columns = row.split(',');
            if (columns.length >= 2) {
                pacientes.push({
                    nombre: columns[0].trim(),
                    telefono: columns[1].trim(),
                    email: columns[2] ? columns[2].trim() : ""
                });
            }
        });

        if (pacientes.length === 0) {
            alert("‚ö†Ô∏è El archivo parece estar vac√≠o o mal formateado.");
            return;
        }

        // Env√≠o profesional al servidor
        try {
            const res = await fetch('/api/dashboard/importar-pacientes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ clinic_id: clinicId, pacientes: pacientes })
            });
            const result = await res.json();
            
            if (result.success) {
                alert(`‚úÖ ¬°√âxito! Se han importado ${result.total} pacientes correctamente.`);
                loadCRM(); // Recargamos la lista visualmente
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            alert("‚ùå Fallo en la subida a la nube: " + error.message);
        }
    };
    reader.readAsText(file);
}
async function agregarSede() {
    const calle = prompt("Calle / Avenida:");
    if (!calle) return;
    const ciudad = prompt("Ciudad:");
    const cp = prompt("C√≥digo Postal:");
    
    try {
        const res = await fetch('/api/dashboard/add-sede', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                clinic_id: clinicId, 
                calle: calle, 
                numero: "", 
                cp: cp, 
                ciudad: ciudad 
            })
        });
        if (res.ok) {
            alert("‚úÖ Sede a√±adida con √©xito.");
            location.reload(); // Recargamos para que Ana y el panel vean la nueva sede
        }
    } catch (e) {
        alert("Error al guardar la sede.");
    }
}
async function enviarSugerencia() {
    const texto = document.getElementById('sugerenciaTxt').value;
    if (!texto.trim()) return alert("Por favor, escribe algo antes de enviar.");

    const btn = event.target;
    const statusDiv = document.getElementById('statusSugerencia');
    
    btn.disabled = true;
    btn.innerText = "Enviando idea...";

    try {
        const res = await fetch('/api/dashboard/enviar-sugerencia', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ clinic_id: clinicId, texto: texto })
        });

        if (res.ok) {
            document.getElementById('sugerenciaTxt').value = "";
            statusDiv.style.display = "block";
            statusDiv.style.color = "var(--success)";
            statusDiv.innerText = "‚úÖ ¬°Gracias! Tu sugerencia ha sido registrada para revisi√≥n.";
            btn.innerText = "ENVIADO CON √âXITO";
        } else {
            throw new Error();
        }
    } catch (e) {
        alert("Error al conectar con el servidor.");
        btn.disabled = false;
        btn.innerText = "REINTENTAR ENV√çO";
    }
}
async function asignarBono(num) {
    if (!confirm(`¬øConfirmas la venta de un bono de ${num} sesiones a ${curNombre}?`)) return;

    try {
        const res = await fetch('/api/dashboard/vender-bono', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                clinic_id: clinicId,
                telefono: curTlf,
                nombre: curNombre,
                sesiones: num
            })
        });
        if (res.ok) {
            alert("‚úÖ Bono asignado. Ana ya puede usarlo.");
            loadFichaData();
        }
    } catch (e) { alert("Error al asignar bono."); }
}
async function ejecutarBloqueo() {
    const start = document.getElementById('blockStart').value;
    const end = document.getElementById('blockEnd').value;
    const motivo = document.getElementById('blockMotivo').value;
    if (!start || !end) return alert("Selecciona fechas.");
    const res = await fetch('/api/dashboard/bloquear-agenda', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clinic_id: clinicId, fecha_inicio: start, fecha_fin: end, motivo: motivo })
    });
    if (res.ok) { alert("‚úÖ Bloqueo activado."); location.reload(); }
}
async function loadBalance() {
    try {
        const res = await fetch(`/api/dashboard/balance?clinic_id=${clinicId}`);
        const d = await res.json();
        document.getElementById('ingReal').innerText = d.real + "‚Ç¨";
        document.getElementById('ingPot').innerText = d.potencial + "‚Ç¨";
        document.getElementById('roiVal').innerText = d.roi + "%";
        document.getElementById('totalCitasExito').innerText = d.citas_exito;
    } catch (e) { console.error("Error cargando contabilidad"); }
}

// Actualizamos la funci√≥n showSection para que cargue los datos al entrar
const originalShowSection = showSection;
showSection = function(id) {
    if (id === 'finanzas') loadBalance();
    originalShowSection(id);
}
</script>
</body>
</html>