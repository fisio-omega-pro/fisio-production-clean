<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FisioTool Pro - Gesti√≥n de √âlite</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/es.global.min.js'></script>

<style>
:root {
--primary: #0066ff;
--primary-dark: #0052cc;
--primary-light: #eef5ff;
--success: #10b981;
--danger: #ef4444;
--warning: #f59e0b;
--bg-body: #f8fafc;
--white: #ffffff;
--text-main: #0f172a;
--text-muted: #64748b;
--border: #e2e8f0;
--radius-xl: 32px;
--radius-lg: 24px;
--shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
--shadow-md: 0 10px 15px -3px rgba(0,0,0,0.05);
--shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1);
}

body { 
  font-family: 'Inter', sans-serif; 
  background: var(--bg-body); 
  margin: 0; 
  display: flex; 
  height: 100vh; 
  color: var(--text-main); 
  overflow: hidden; 
}

.sidebar {
  width: 300px; 
  background: var(--white); 
  border-right: 1px solid var(--border);
  display: flex; 
  flex-direction: column; 
  padding: 40px 30px; 
  box-sizing: border-box;
  box-shadow: 10px 0 30px rgba(0,0,0,0.02);
}

.logo-box { 
  font-size: 26px; 
  font-weight: 800; 
  color: var(--primary); 
  margin-bottom: 50px; 
  display: flex; 
  align-items: center; 
  gap: 15px; 
  letter-spacing: -1px; 
}

.logo-icon { 
  width: 16px; 
  height: 16px; 
  background: var(--primary); 
  border-radius: 5px; 
  box-shadow: 0 0 15px var(--primary); 
}

.nav-group { margin-bottom: 35px; }

.nav-label { 
  font-size: 11px; 
  font-weight: 800; 
  color: #94a3b8; 
  text-transform: uppercase; 
  letter-spacing: 1.5px; 
  margin-bottom: 15px; 
  padding-left: 10px; 
}

.nav-item {
  padding: 16px 20px; 
  margin-bottom: 10px; 
  border-radius: var(--radius-lg); 
  cursor: pointer; 
  color: var(--text-muted);
  display: flex; 
  align-items: center; 
  gap: 15px; 
  transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
  font-weight: 600; 
  font-size: 14px;
}

.nav-item:hover { 
  background: #f1f5f9; 
  color: var(--primary); 
  transform: translateX(5px); 
}

.nav-item.active { 
  background: var(--primary-light); 
  color: var(--primary); 
  box-shadow: 0 4px 12px rgba(0,102,255,0.1); 
}

.main { 
  flex: 1; 
  padding: 45px; 
  overflow-y: auto; 
  display: flex; 
  flex-direction: column; 
}

.header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 40px; 
}

.header h1 { 
  font-size: 32px; 
  font-weight: 800; 
  margin: 0; 
  letter-spacing: -1px; 
}

.main-section { 
  display: none; 
  flex-direction: column; 
  height: 100%; 
  animation: slideIn 0.5s ease-out; 
}

.main-section.active { display: flex; }

#calendar { 
  background: var(--white); 
  padding: 30px; 
  border-radius: var(--radius-xl); 
  box-shadow: var(--shadow-lg); 
  flex: 1; 
  border: 1px solid rgba(255,255,255,0.7); 
}

.glass-card { 
  background: var(--white); 
  padding: 35px; 
  border-radius: var(--radius-xl); 
  box-shadow: var(--shadow-lg); 
  border: 1px solid var(--border); 
}

.btn-pro {
  background: #25D366; 
  color: white; 
  padding: 14px 28px; 
  border-radius: 60px; 
  text-decoration: none;
  font-weight: 700; 
  font-size: 14px; 
  border: none; 
  cursor: pointer; 
  display: flex; 
  align-items: center; 
  gap: 10px;
  box-shadow: 0 10px 20px rgba(37, 211, 102, 0.2); 
  transition: 0.3s;
}

.btn-pro:hover { 
  transform: translateY(-3px); 
  box-shadow: 0 15px 30px rgba(37, 211, 102, 0.3); 
}

.modal { 
  display: none; 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%; 
  background: rgba(15, 23, 42, 0.7); 
  z-index: 5000; 
  justify-content: center; 
  align-items: center; 
  backdrop-filter: blur(12px); 
}

.modal-content { 
  background: var(--white); 
  padding: 50px; 
  border-radius: 40px; 
  width: 750px; 
  max-width: 95%; 
  max-height: 90vh; 
  overflow-y: auto; 
  position: relative; 
  box-shadow: 0 40px 100px rgba(0,0,0,0.3); 
}

.form-group { margin-bottom: 30px; }

.form-group label { 
  display: block; 
  margin-bottom: 12px; 
  font-size: 13px; 
  font-weight: 800; 
  color: var(--text-muted); 
  text-transform: uppercase; 
  letter-spacing: 1px; 
}

input, select, textarea {
  width: 100%; 
  padding: 16px; 
  border: 1px solid var(--border); 
  border-radius: 16px;
  font-size: 16px; 
  box-sizing: border-box; 
  background: #fdfdfd; 
  transition: 0.3s;
}

input:focus, textarea:focus { 
  border-color: var(--primary); 
  outline: none; 
  background: white; 
  box-shadow: 0 0 0 5px var(--primary-light); 
}

.tabs { 
  display: flex; 
  gap: 40px; 
  margin-bottom: 35px; 
  border-bottom: 2px solid #f1f5f9; 
}

.tab-btn {
  padding: 15px 0; 
  border: none; 
  background: none; 
  color: var(--text-muted); 
  cursor: pointer;
  font-weight: 700; 
  font-size: 15px; 
  border-bottom: 4px solid transparent; 
  transition: 0.3s;
}

.tab-btn.active { 
  color: var(--primary); 
  border-bottom-color: var(--primary); 
}

.voice-hub { 
  background: #f8fafc; 
  border-radius: 24px; 
  padding: 35px; 
  margin-bottom: 25px; 
  border: 2px solid #f1f5f9; 
  text-align: center; 
}

#btnMicro {
  width: 80px; 
  height: 80px; 
  border-radius: 50%; 
  border: none; 
  background: var(--primary);
  color: white; 
  cursor: pointer; 
  font-size: 32px; 
  display: flex; 
  align-items: center;
  justify-content: center; 
  margin: 0 auto 25px; 
  box-shadow: 0 15px 35px rgba(0,102,255,0.4); 
  transition: 0.4s;
}

#btnMicro.recording { 
  background: var(--danger); 
  animation: pulse-red 1.5s infinite; 
  transform: scale(1.1); 
}

@keyframes pulse-red { 
  0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 
  70% { box-shadow: 0 0 0 25px rgba(239, 68, 68, 0); } 
  100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } 
}

table { 
  width: 100%; 
  border-collapse: separate; 
  border-spacing: 0 15px; 
}

th { 
  padding: 15px; 
  text-align: left; 
  color: #94a3b8; 
  font-size: 12px; 
  font-weight: 800; 
  text-transform: uppercase; 
}

td { 
  padding: 25px 20px; 
  background: white; 
  border-top: 1px solid #f1f5f9; 
  border-bottom: 1px solid #f1f5f9; 
  font-weight: 500; 
}

tr td:first-child { 
  border-left: 1px solid #f1f5f9; 
  border-top-left-radius: 20px; 
  border-bottom-left-radius: 20px; 
}

tr td:last-child { 
  border-right: 1px solid #f1f5f9; 
  border-top-right-radius: 20px; 
  border-bottom-right-radius: 20px; 
}

@keyframes slideIn { 
  from { opacity: 0; transform: translateY(20px); } 
  to { opacity: 1; transform: translateY(0); } 
}

.btn-save {
  background: var(--success);
  color: white;
  padding: 18px;
  border: none;
  border-radius: 16px;
  font-weight: 800;
  font-size: 16px;
  cursor: pointer;
  transition: 0.3s;
}

.btn-save:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
}

.btn-cancel {
  background: #f1f5f9;
  color: var(--text-muted);
  padding: 18px;
  border: none;
  border-radius: 16px;
  font-weight: 800;
  font-size: 16px;
  cursor: pointer;
  transition: 0.3s;
}

.btn-cancel:hover {
  background: #e2e8f0;
}
</style>
</head>
<body>

<div class="sidebar">
  <div class="logo-box">
    <div class="logo-icon"></div> 
    FisioTool 
    <span style="font-size: 10px; background: #eee; padding: 2px 8px; border-radius: 6px; color: #666; margin-left: 8px;">PRO</span>
  </div>

  <div class="nav-group">
    <div class="nav-label">Panel Operativo</div>
    <div class="nav-item active" id="nav-agenda" onclick="showSection('agenda')">üìÖ Agenda Visual</div>
    <div class="nav-item" id="nav-pacientes" onclick="showSection('pacientes')">üë• CRM Pacientes</div>
  </div>

  <div class="nav-group">
    <div class="nav-label">Crecimiento</div>
    <div class="nav-item" id="nav-bonos" onclick="showSection('bonos')">üéüÔ∏è Gesti√≥n de Bonos</div>
    <div class="nav-item" id="nav-afiliados" onclick="showSection('afiliados')">üíé Link de Afiliado</div>
  </div>

  <div class="nav-group" style="margin-top: auto;">
    <div class="nav-item" id="nav-ajustes" onclick="showSection('ajustes')">‚öôÔ∏è Sedes y Ajustes</div>
  </div>
</div>

<div class="main">
  <div class="header">
    <h1 id="titleDisplay">Agenda Semanal</h1>
    <div style="display:flex; gap:15px;">
      <button class="btn-pro" style="background:#000;" onclick="copyClinicLink()">üîó Enlace Citas</button>
    </div>
  </div>

  <!-- SECCI√ìN 1: AGENDA -->
  <div id="section-agenda" class="main-section active">
    <div id="calendar"></div>
  </div>

  <!-- SECCI√ìN 2: CRM PACIENTES -->
  <div id="section-pacientes" class="main-section">
    <div class="glass-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h3>Base de Datos Inteligente</h3>
        <button class="btn-pro" style="background:var(--primary); font-size:12px;" onclick="document.getElementById('fileUpload').click()">üìÅ Cargar Base de Datos (CSV)</button>
        <input type="file" id="fileUpload" style="display:none;" onchange="handleFileUpload(this)">
      </div>
      <div id="pacientesLista">
        <p style="text-align:center; color:#94a3b8;">Cargando historial de pacientes...</p>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN 3: BONOS -->
  <div id="section-bonos" class="main-section">
    <div class="glass-card">
      <h3>Venta y Control de Bonos</h3>
      <p style="color:var(--text-muted); font-size:15px; margin-bottom:30px;">Asigna sesiones prepagadas a tus pacientes para que Ana gestione el saldo autom√°ticamente.</p>
      <div id="listaBonosTable">
        <p style="text-align:center; color:#94a3b8;">M√≥dulo en desarrollo...</p>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN 4: AFILIADOS -->
  <div id="section-afiliados" class="main-section">
    <div class="glass-card" style="text-align:center; padding:80px 40px;">
      <div style="font-size:70px; margin-bottom:30px;">üíé</div>
      <h2>Programa de Recomendaci√≥n</h2>
      <p style="color:var(--text-muted); max-width:500px; margin: 0 auto 40px; font-size:16px;">Comparte tu √©xito. Por cada colega que se registre con tu enlace, aplicaremos un <strong>50% de descuento</strong> a ambos de por vida.</p>
      <div id="refLink" style="background:var(--bg-body); padding:25px; border-radius:20px; font-family:monospace; font-weight:800; font-size:18px; margin-bottom:30px; border:2px dashed var(--border);">...</div>
      <button class="btn-pro" style="margin:0 auto; padding:18px 40px;" onclick="copyReferral()">COPIAR MI ENLACE</button>
    </div>
  </div>

  <!-- SECCI√ìN 5: AJUSTES / SEDES -->
  <div id="section-ajustes" class="main-section">
    <div class="glass-card" style="margin-bottom:30px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>üè¢ Sedes y Localizaciones</h3>
        <button class="btn-pro" style="background:var(--text-dark);" onclick="alert('Funcionalidad para a√±adir nueva direcci√≥n')">+ A√±adir Sede</button>
      </div>
      <div id="sedesGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:25px;"></div>
    </div>
    <div class="glass-card">
      <h3>üõ°Ô∏è Seguridad y GDPR</h3>
      <div style="padding:15px; background:var(--primary-light); border-radius:15px; border-left:5px solid var(--primary);">
        <p style="font-size:14px; margin:0;"><strong>Estatus Legal:</strong> Todos tus pacientes han aceptado los t√©rminos de tratamiento de datos al registrarse con la IA.</p>
      </div>
    </div>
  </div>
</div>

<!-- MODAL RESERVA MANUAL -->
<div id="modalManual" class="modal">
  <div class="modal-content">
    <h2 style="margin-top:0">Reserva Manual</h2>
    <form id="formManual">
      <input type="hidden" id="manualDate">
      <div class="form-group"><label>Nombre Completo</label><input type="text" id="mNombre" required></div>
      <div class="form-group"><label>Tel√©fono Contacto</label><input type="text" id="mTlf"></div>
      <div class="form-group"><label>Notas Cl√≠nicas Previas</label><textarea id="mNotas" rows="2"></textarea></div>
      <div style="display:flex; gap:20px;">
        <button type="button" class="btn-cancel" style="flex:1" onclick="closeModal('modalManual')">Cancelar</button>
        <button type="submit" class="btn-save" style="flex:2">Agendar Ahora</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL FICHA DE PACIENTE -->
<div id="modalFicha" class="modal">
  <div class="modal-content" style="width: 850px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:35px;">
      <h2 style="margin:0">Ficha Cl√≠nica Digital</h2>
      <button onclick="closeModal('modalFicha')" style="background:none; border:none; font-size:40px; cursor:pointer; color:#cbd5e1;">&times;</button>
    </div>

    <div style="background:linear-gradient(135deg, #0066ff, #0044aa); padding:35px; border-radius:30px; margin-bottom:40px; display:flex; justify-content:space-between; align-items:center; color:white; box-shadow: 0 15px 30px rgba(0,102,255,0.2);">
      <div>
        <h3 id="fName" style="margin:0; font-size:24px; font-weight:800;">...</h3>
        <span id="fTlf" style="font-size:15px; opacity:0.8; font-weight:500;"></span>
      </div>
      <div id="fBonoTag" style="background:rgba(255,255,255,0.2); padding:12px 25px; border-radius:15px; font-size:13px; font-weight:800; border:1px solid rgba(255,255,255,0.3);">üéüÔ∏è BONO ACTIVO</div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab(this, 'notas')">üìù Evoluci√≥n M√©dica</button>
      <button class="tab-btn" onclick="switchTab(this, 'chat')">üí¨ Historial Chat IA</button>
      <button class="tab-btn" onclick="switchTab(this, 'pagos')">üí≥ Pagos y Bonos</button>
    </div>

    <div id="tab-notas" class="tab-pane">
      <div class="voice-hub">
        <button id="btnMicro" onclick="toggleVoice()">üé§</button>
        <p id="micStatus" style="font-size:12px; font-weight:800; color:var(--danger); visibility:hidden;">üî¥ GRABANDO... HABLA AHORA</p>
        <label style="display:block; text-align:left; margin-bottom:12px; color:var(--text-gray);">TRANSCRIPCI√ìN EN TIEMPO REAL (Edita antes de guardar):</label>
        <textarea id="voiceResult" rows="6" style="background:white; border:2px solid #f1f5f9; font-weight:500;" placeholder="Pulsa el micro para dictar la evoluci√≥n del paciente..."></textarea>
      </div>
      <div style="display:flex; gap:20px;">
        <button onclick="saveNote()" style="flex:2; background:var(--success); color:white; padding:18px; font-size:16px; border:none; border-radius:16px; font-weight:800; cursor:pointer;">‚úÖ VALIDAR Y GUARDAR EN HISTORIAL</button>
        <button onclick="document.getElementById('voiceResult').value=''" style="flex:1; background:#f1f5f9; color:var(--text-muted); padding:18px; border:none; border-radius:16px; font-weight:800; cursor:pointer;">Limpiar</button>
      </div>
      <div id="clinicalHistory" style="margin-top:40px;"></div>
    </div>

    <div id="tab-chat" class="tab-pane" style="display:none;">
      <div id="chatLog" style="max-height:450px; overflow-y:auto; padding:10px;"></div>
    </div>

    <div id="tab-pagos" class="tab-pane" style="display:none;">
      <div style="background:#f8fafc; border-radius:20px; padding:30px; text-align:center; border:2px dashed #e2e8f0;">
        <h4 style="margin-top:0">üéüÔ∏è Venta de Bonos</h4>
        <p style="color:var(--text-muted); font-size:14px;">El paciente podr√° usar estas sesiones para reservar citas con Ana sin pagar fianza.</p>
        <button class="btn-pro" style="margin: 0 auto; background:var(--primary);">+ Generar Bono de 5 Sesiones</button>
      </div>
    </div>
  </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const clinicId = params.get('id');
let calendar, recognition, curTlf, curNombre;

document.addEventListener('DOMContentLoaded', function() {
  if(!clinicId) { 
    document.body.innerHTML = "<div style='padding:100px; text-align:center;'><h1>403</h1><p>Acceso denegado. Se requiere Token de Cl√≠nica.</p></div>"; 
    return; 
  }

  initCalendar();
  initVoice();
  loadClinicData();
});

function initCalendar() {
  const el = document.getElementById('calendar');
  calendar = new FullCalendar.Calendar(el, {
    initialView: 'timeGridWeek',
    locale: 'es',
    firstDay: 1,
    buttonText: { today: 'Hoy', month: 'Mes', week: 'Semana', day: 'D√≠a', list: 'Lista' },
    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
    slotMinTime: '08:00:00', 
    slotMaxTime: '21:00:00', 
    allDaySlot: false, 
    height: '100%',
    nowIndicator: true,
    events: `/api/dashboard/calendar?clinic_id=${clinicId}`,
    dateClick: (info) => openManual(info.dateStr),
    eventClick: (info) => openFicha(info.event)
  });
  calendar.render();
}

function initVoice() {
  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.onresult = (e) => {
      let text = "";
      for (let i = e.resultIndex; i < e.results.length; i++) {
        text += e.results[i][0].transcript;
      }
      document.getElementById('voiceResult').value = text;
    };
  }
}

async function loadClinicData() {
  try {
    const res = await fetch(`/api/config/${clinicId}`);
    const data = await res.json();

    document.getElementById('refLink').innerText = `${window.location.origin}/setup?ref=${data.mi_codigo_referido || 'FT-PRO'}`;

    const sedes = data.direcciones || [];
    document.getElementById('sedesGrid').innerHTML = sedes.map(s => `
      <div style="background:#fff; border:1px solid #f1f5f9; padding:20px; border-radius:18px; position:relative;">
        <div style="font-size:12px; font-weight:800; color:var(--success); margin-bottom:10px;">SEDE PRINCIPAL</div>
        <div style="font-weight:700;">${s.calle} ${s.numero}</div>
        <div style="color:var(--text-muted); font-size:13px;">${s.cp}, ${s.ciudad}</div>
      </div>
    `).join('');
  } catch(e) {
    console.error("Error cargando config:", e);
  }
}

function showSection(id) {
  document.querySelectorAll('.main-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('section-' + id).classList.add('active');
  document.getElementById('nav-' + id).classList.add('active');

  const titles = { 
    agenda: 'Agenda Semanal', 
    pacientes: 'Base de Datos de Pacientes', 
    bonos: 'Gesti√≥n de Bonos', 
    afiliados: 'Programa Afiliados', 
    ajustes: 'Sedes y Ajustes' 
  };
  document.getElementById('titleDisplay').innerText = titles[id];
  
  if(id === 'pacientes') loadCRM();
}

function switchTab(btn, id) {
  document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + id).style.display = 'block';
  btn.classList.add('active');
}

async function loadCRM() {
  const container = document.getElementById('pacientesLista');
  try {
    const res = await fetch(`/api/dashboard/pacientes?clinic_id=${clinicId}`);
    const data = await res.json();
    
    if(!data.length) { 
      container.innerHTML = '<p style="text-align:center; padding:40px; color:#94a3b8;">No hay pacientes registrados a√∫n.</p>'; 
      return; 
    }

    let h = '<table><thead><tr><th>PACIENTE</th><th>TEL√âFONO</th><th>√öLTIMA VISITA</th><th>ACCIONES</th></tr></thead><tbody>';
    data.forEach(p => {
      h += `<tr>
        <td style="font-weight:700;">${p.nombre}</td>
        <td>${p.telefono}</td>
        <td>${new Date(p.ultimaCita).toLocaleDateString()}</td>
        <td style="text-align:right;">
          <button onclick="openFichaManual('${p.telefono}', '${p.nombre}')" style="background:var(--primary-light); color:var(--primary); border:none; padding:10px 20px; border-radius:12px; font-weight:700; cursor:pointer;">VER FICHA</button>
        </td>
      </tr>`;
    });
    container.innerHTML = h + '</tbody></table>';
  } catch(e) { 
    container.innerHTML = 'Error de conexi√≥n.'; 
    console.error("Error CRM:", e);
  }
}

function openFicha(ev) { 
  openFichaManual(ev.extendedProps.telefono, ev.title.replace(/\(.*\)/, '').trim()); 
}

function openFichaManual(tlf, nombre) {
  curTlf = tlf; 
  curNombre = nombre;
  document.getElementById('modalFicha').style.display = 'flex';
  document.getElementById('fName').innerText = nombre;
  document.getElementById('fTlf').innerText = 'üìû ' + tlf;
  document.getElementById('voiceResult').value = "";
  switchTab(document.querySelector('.tab-btn'), 'notas');
  loadFichaData();
}

async function loadFichaData() {
  const hBox = document.getElementById('clinicalHistory');
  const cBox = document.getElementById('chatLog');
  hBox.innerHTML = '<p style="text-align:center;">Cargando...</p>';

  try {
    const tlfLimpio = curTlf.replace(/\s+/g, '').replace('+34', '');
    const res = await fetch(`/api/dashboard/paciente-info?clinic_id=${clinicId}&telefono=${tlfLimpio}`);
    const data = await res.json();

    hBox.innerHTML = data.notas.length ? data.notas.map(n => `
      <div style="background:#fff; border:1px solid #f1f5f9; padding:20px; border-radius:18px; margin-bottom:12px; border-left:6px solid var(--success); box-shadow:var(--shadow-sm);">
        <small style="font-weight:800; color:var(--primary);">${new Date(n.creado._seconds*1000).toLocaleString()}</small>
        <p style="margin:10px 0 0 0; line-height:1.6;">${n.contenido}</p>
      </div>
    `).join('') : '<p style="text-align:center; font-size:13px; color:#94a3b8;">Sin notas evolutivas todav√≠a.</p>';

    cBox.innerHTML = data.chats.length ? data.chats.map(c => `
      <div style="margin-bottom:20px; display:flex; flex-direction:column; gap:8px;">
        <div style="align-self:flex-end; background:var(--primary-light); color:var(--primary); padding:12px 18px; border-radius:18px 18px 0 18px; font-size:14px; font-weight:500;">${c.msg || c.usr}</div>
        <div style="align-self:flex-start; background:#f1f5f9; color:var(--text-dark); padding:12px 18px; border-radius:18px 18px 18px 0; font-size:14px; border:1px solid #e2e8f0;">${c.reply || c.ia}</div>
      </div>
    `).join('') : '<p style="text-align:center; font-size:13px; color:#94a3b8;">Sin historial de chat con Ana.</p>';
  } catch(e) {
    console.error("Error cargando ficha:", e);
    hBox.innerHTML = '<p style="color:red;">Error al cargar datos</p>';
  }
}

function toggleVoice() {
  if(!recognition) return alert("Micr√≥fono no soportado en este navegador.");
  const btn = document.getElementById('btnMicro');
  
  if(btn.classList.contains('recording')) { 
    recognition.stop();
    btn.classList.remove('recording');
    document.getElementById('micStatus').style.visibility = 'hidden'; 
  } else { 
    recognition.start(); 
    btn.classList.add('recording');
    document.getElementById('micStatus').style.visibility = 'visible'; 
  }
}

async function saveNote() {
  const t = document.getElementById('voiceResult').value;
  if(!t.trim()) return alert("La nota est√° vac√≠a.");
  
  const btn = event.target; 
  btn.disabled = true; 
  btn.innerText = "Guardando...";

  try {
    await fetch('/api/dashboard/guardar-nota', { 
      method: 'POST',
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify({ 
        clinic_id: clinicId, 
        telefono: curTlf, 
        nombre: curNombre, 
        texto: t 
      }) 
    });

    btn.disabled = false; 
    btn.innerText = "‚úÖ VALIDAR Y GUARDAR EN HISTORIAL";
    document.getElementById('voiceResult').value = ""; 
    loadFichaData();
    alert("‚úÖ Nota guardada correctamente");
  } catch(e) {
    console.error("Error guardando nota:", e);
    btn.disabled = false;
    alert("Error al guardar la nota");
  }
}

function openManual(d) {
  document.getElementById('modalManual').style.display = 'flex';
  document.getElementById('manualDate').value = d;
}

function closeModal(id) { 
  document.getElementById(id).style.display = 'none'; 
}

function copyClinicLink() {
  navigator.clipboard.writeText(`${window.location.origin}/${clinicId}`);
  alert("‚úÖ Enlace para pacientes copiado.");
}

function copyReferral() {
  navigator.clipboard.writeText(document.getElementById('refLink').innerText);
  alert("üíé Enlace de afiliado copiado.");
}

document.getElementById('formManual').addEventListener('submit', async (e) => {
  e.preventDefault();

  try {
    await fetch('/api/dashboard/cita-manual', { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify({
        clinic_id: clinicId, 
        fecha: document.getElementById('manualDate').value, 
        nombre: document.getElementById('mNombre').value, 
        telefono: document.getElementById('mTlf').value, 
        notas: document.getElementById('mNotas').value 
      }) 
    });

    closeModal('modalManual'); 
    calendar.refetchEvents();
    e.target.reset();
    alert("‚úÖ Cita creada correctamente");
  } catch(e) {
    console.error("Error creando cita:", e);
    alert("Error al crear la cita");
  }
});

function handleFileUpload(input) { 
  alert("M√≥dulo de importaci√≥n masiva detectado. Preparando subida segura a Firestore..."); 
}
</script>
</body>
</html>