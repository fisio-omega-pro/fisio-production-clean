document.addEventListener('DOMContentLoaded', async () => {
    
    // --- 1. DETECTAR QUI√âN ES LA CL√çNICA (Slug de la URL) ---
    // Coge la √∫ltima parte: tudominio.com/clinica-ers -> 'clinica-ers'
    const pathParts = window.location.pathname.split('/').filter(p => p.length > 0);
    const clinicSlug = pathParts[pathParts.length - 1]; 

    console.log("üîç Inicializando Landing para:", clinicSlug);

    // Referencias a los elementos del HTML
    const ui = {
        title: document.getElementById('pageTitle'),
        clinicName: document.getElementById('clinicName'),
        logo: document.getElementById('clinicLogo'),
        anaImg: document.getElementById('anaImage'),
        address: document.getElementById('infoAddress'),
        phone: document.getElementById('infoPhone'),
        schedule: document.getElementById('infoSchedule'),
        chatBox: document.getElementById('chatBox'),
        input: document.getElementById('messageInput'),
        sendBtn: document.getElementById('sendButton'),
        tlfInput: document.getElementById('patientTlf')
    };

    let botName = "Asistente"; // Nombre por defecto

    // --- 2. FUNCI√ìN PARA PINTAR MENSAJES (Burbujas) ---
    function renderMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `message ${sender}`; // 'user' (verde) o 'ana' (gris)
        div.innerHTML = text.replace(/\n/g, '<br>'); // Respeta saltos de l√≠nea
        ui.chatBox.appendChild(div);
        ui.chatBox.scrollTop = ui.chatBox.scrollHeight; // Baja el scroll autom√°ticamente
    }

    // --- 3. FUNCI√ìN MAESTRA: CARGAR CONFIGURACI√ìN ---
    async function loadConfig() {
        if (!clinicSlug) {
            renderMessage("‚õî Error Cr√≠tico: No se ha especificado ninguna cl√≠nica en la URL.", 'ana');
            return;
        }

        try {
            // Llamamos a nuestro Backend Inteligente
            const response = await fetch(`/api/config/${clinicSlug}`);
            
            if (!response.ok) throw new Error("Cl√≠nica no encontrada en la Base de Datos");

            const data = await response.json();

            // === APLICAR DATOS A LA PANTALLA ===
            ui.title.innerText = `Citas - ${data.nombre_clinica}`;
            ui.clinicName.innerText = data.nombre_clinica;
            
            // Si no hay logo, ponemos uno gen√©rico m√©dico
            ui.logo.src = data.logo_url && data.logo_url.startsWith('http') 
                          ? data.logo_url 
                          : "https://cdn-icons-png.flaticon.com/512/3774/3774299.png";
            
            // Si no hay avatar, ponemos una chica generada por IA (borra esto y pon tu URL real luego)
            ui.anaImg.src = data.bot_avatar || "https://i.pravatar.cc/150?u=receptionist";
            
            ui.address.innerText = data.address || "Direcci√≥n no disponible";
            ui.phone.innerText = data.phone || "Consultar web";
            botName = data.bot_nombre || "Laura";

            // Mostrar horario de forma elegante
            if (data.weekly_schedule) {
                // Simplificaci√≥n visual
                ui.schedule.innerText = "üìÖ Abierto: Consulta disponibilidad en el chat.";
            } else {
                ui.schedule.innerText = "Cita Previa";
            }

            // DESBLOQUEAR EL CHAT (Ahora que sabemos que la cl√≠nica existe)
            ui.input.disabled = false;
            ui.sendBtn.disabled = false;
            ui.input.placeholder = "Escribe aqu√≠...";

            // SALUDO AUTOM√ÅTICO
            renderMessage(`üëã ¬°Hola! Soy ${botName}, la recepcionista virtual de ${data.nombre_clinica}. ¬øEn qu√© puedo ayudarte?`, 'ana');

        } catch (error) {
            console.error(error);
            ui.clinicName.innerText = "Error 404";
            renderMessage(`‚ùå Lo sentimos, no encontramos la cl√≠nica: ${clinicSlug}. Verifica la URL.`, 'ana');
        }
    }

    // --- 4. FUNCI√ìN PARA ENVIAR EL MENSAJE ---
    async function sendMessage() {
        const text = ui.input.value.trim();
        const tlf = ui.tlfInput.value.trim(); // Tel√©fono sin validar estricto

        if (!text) return;

        // Validaci√≥n suave del tel√©fono (solo pedimos que tenga n√∫meros)
        if (tlf.length < 6) {
            alert("‚ö†Ô∏è Por favor, escribe tu n¬∫ de m√≥vil en la casilla peque√±a antes de enviar el mensaje. Lo necesitamos para la reserva.");
            ui.tlfInput.style.borderColor = "red";
            ui.tlfInput.focus();
            return;
        } else {
            ui.tlfInput.style.borderColor = "#ccc"; // Quitar rojo si estaba
        }

        // 1. Pintar mensaje del usuario
        renderMessage(text, 'user');
        ui.input.value = '';
        ui.input.disabled = true; // Bloquear para que no env√≠e doble
        ui.sendBtn.innerText = "...";

        try {
            // Enviamos al backend
            const res = await fetch(`/api/chat/${clinicSlug}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text, patient_tlf: tlf })
            });

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.error || "Error servidor");
            }

            const data = await res.json();
            
            // 2. Respuesta de Ana
            renderMessage(data.reply, 'ana');

        } catch (error) {
            renderMessage("üîå Ups, he tenido un micro-corte de conexi√≥n. ¬øPuedes repet√≠rmelo?", 'ana');
            console.error(error);
        } finally {
            // Reactivar controles
            ui.input.disabled = false;
            ui.sendBtn.innerText = "Enviar";
            ui.input.focus();
        }
    }

    // Eventos (Clicks y Enter)
    ui.sendBtn.addEventListener('click', sendMessage);
    ui.input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // ARRANCAR
    loadConfig();
});