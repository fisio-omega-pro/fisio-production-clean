document.addEventListener('DOMContentLoaded', async () => {
    // 1. OBTENER EL SLUG DE LA URL (Ej: 'clinica-ers')
    // Esto funciona tanto para /agenda/ID como para /nombre-clinica
    const pathParts = window.location.pathname.split('/').filter(p => p.length > 0);
    const clinicSlug = pathParts[pathParts.length - 1]; // Toma la √∫ltima parte de la URL

    console.log("üîç Buscando cl√≠nica:", clinicSlug);

    const ui = {
        title: document.getElementById('pageTitle'),
        clinicName: document.getElementById('clinicName'),
        logo: document.getElementById('clinicLogo'),
        anaImg: document.getElementById('anaImage'),
        address: document.getElementById('infoAddress'),
        phone: document.getElementById('infoPhone'),
        schedule: document.getElementById('infoSchedule'),
        chatBox: document.getElementById('chatBox'),
        input: document.getElementById('messageInput'),
        sendBtn: document.getElementById('sendButton'),
        tlfInput: document.getElementById('patientTlf')
    };

    let botName = "Asistente";

    // 2. FUNCI√ìN PARA CARGAR LA CONFIGURACI√ìN DE LA CL√çNICA
    async function loadConfig() {
        try {
            const response = await fetch(`/api/config/${clinicSlug}`);
            
            if (!response.ok) throw new Error("Cl√≠nica no encontrada");

            const data = await response.json();
            
            // Rellenar datos visuales
            ui.title.innerText = `Citas - ${data.landing_titulo}`;
            ui.clinicName.innerText = data.landing_titulo;
            ui.logo.src = data.logo_url || "https://via.placeholder.com/40"; // Fallback
            ui.anaImg.src = data.bot_avatar || "https://i.pravatar.cc/150?img=5"; // Fallback
            ui.address.innerText = data.address || "Direcci√≥n no disponible";
            ui.phone.innerText = data.phone || "Consultar web";
            botName = data.bot_nombre || "Laura";

            // Formatear el horario (Viene en JSON complejo, lo simplificamos para visual)
            if (data.weekly_schedule) {
                // Truco r√°pido para mostrar si est√° abierto hoy
                ui.schedule.innerText = "Consultar disponibilidad en el chat."; 
            } else {
                ui.schedule.innerText = "Horario bajo cita previa.";
            }

            // Habilitar el chat
            ui.input.disabled = false;
            ui.sendBtn.disabled = false;

            // Saludo Inicial
            addMessage(`üëã Hola, soy ${botName}. Estoy conectada con la agenda de ${data.nombre_clinica}. ¬øQu√© necesitas?`, 'ana');

        } catch (error) {
            console.error(error);
            ui.clinicName.innerText = "Error";
            ui.chatBox.innerHTML = `<div class="message ana" style="background-color:#ffcccc; color:red;">‚õî No hemos podido cargar la cl√≠nica '${clinicSlug}'. Verifica la URL.</div>`;
        }
    }

    // 3. FUNCI√ìN PARA AGREGAR MENSAJES A LA PANTALLA
    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.classList.add('message', sender);
        div.innerHTML = text.replace(/\n/g, '<br>'); // Respetar saltos de l√≠nea
        ui.chatBox.appendChild(div);
        ui.chatBox.scrollTop = ui.chatBox.scrollHeight; // Auto-scroll al fondo
    }

    // 4. FUNCI√ìN PARA ENVIAR AL BACKEND
    async function sendMessage() {
        const text = ui.input.value.trim();
        const tlf = ui.tlfInput.value.trim();

        if (!text) return;
        
        // Validaci√≥n b√°sica de tel√©fono (ES OBLIGATORIO)
        if (tlf.length < 9) {
            alert("‚ö†Ô∏è Por favor, introduce tu n√∫mero de tel√©fono arriba para poder gestionar tu cita.");
            ui.tlfInput.focus();
            return;
        }

        // 1. Mostrar mensaje del usuario
        addMessage(text, 'user');
        ui.input.value = '';
        ui.input.disabled = true; // Bloquear mientras piensa
        ui.sendBtn.innerText = "...";

        try {
            const res = await fetch(`/api/chat/${clinicSlug}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text, patient_tlf: tlf })
            });

            if (!res.ok) throw new Error("Error en el servidor");

            const data = await res.json();
            
            // 2. Mostrar respuesta de la IA
            addMessage(data.reply, 'ana');

        } catch (error) {
            addMessage("‚ùå Lo siento, he perdido la conexi√≥n moment√°nea. Int√©ntalo de nuevo.", 'ana');
            console.error(error);
        } finally {
            ui.input.disabled = false;
            ui.sendBtn.innerText = "Enviar";
            ui.input.focus();
        }
    }

    // Eventos
    ui.sendBtn.addEventListener('click', sendMessage);
    ui.input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // Arrancamos motores
    loadConfig();
});